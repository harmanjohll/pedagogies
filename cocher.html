<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Co-Cher — Lesson Planning & Spatial Design</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7f9;--panel:#fff;--ink:#1f2937;--muted:#6b7280;--grid:#e5e7eb;--accent:#2563eb;--accent-dark:#1e40af;--accent-2:#16a34a;--accent-3:#f59e0b;--door:#8b5e34;--window:#93c5fd;--danger:#ef4444;--btn-primary-bg:#000C53;--btn-primary-text:#FFE200}
.dark{--bg:#111827;--panel:#1f2937;--ink:#f9fafb;--muted:#9ca3af;--grid:#374151;--accent:#3b82f6;--accent-dark:#60a5fa;--accent-2:#22c55e;--accent-3:#f59e0b;--door:#ab8259;--window:#60a5fa;--btn-primary-bg:#FFE200;--btn-primary-text:#000C53}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,sans-serif;font-size:14px;line-height:1.5;transition:background-color .3s,color .3s}

/* ===== WELCOME SCREEN ===== */
#welcome{position:fixed;inset:0;background:linear-gradient(135deg,#000C53 0%,#1e3a8a 50%,#3b82f6 100%);display:flex;align-items:center;justify-content:center;z-index:1000}
.welcome-card{background:#fff;border-radius:1.5rem;padding:3rem;max-width:480px;width:90%;text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}
.welcome-card h1{font-size:2.5rem;font-weight:700;color:#000C53;margin:0 0 .25rem}
.welcome-card .subtitle{color:#6b7280;margin-bottom:1.5rem}
.welcome-card .tagline{display:inline-block;background:#eef2ff;color:#4338ca;padding:4px 12px;border-radius:999px;font-size:.8rem;font-weight:500;margin-bottom:1.5rem}
.welcome-card label{display:block;text-align:left;font-weight:600;font-size:.875rem;margin-bottom:.25rem}
.welcome-card input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:.875rem;margin-bottom:.5rem;box-sizing:border-box}
.welcome-card .key-help{font-size:.75rem;color:#6b7280;margin-bottom:1.5rem;text-align:left}
.welcome-card .key-help a{color:#2563eb;text-decoration:underline}
.welcome-card .start-btn{width:100%;padding:12px;background:#000C53;color:#FFE200;border:none;border-radius:12px;font-weight:600;font-size:1rem;cursor:pointer;transition:background .2s}
.welcome-card .start-btn:hover{background:#1e3a8a}

/* ===== TOPBAR ===== */
#topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--panel);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin:12px 12px 0;transition:background-color .3s}
.brand{font-size:1.25rem;font-weight:700;color:var(--btn-primary-bg)}
.mode-tabs{display:flex;gap:4px;background:var(--bg);border-radius:10px;padding:3px}
.mode-tab{padding:6px 16px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-weight:500;cursor:pointer;font-size:.875rem;transition:all .2s}
.mode-tab.active{background:var(--panel);color:var(--ink);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.topbar-actions{display:flex;align-items:center;gap:8px}
.topbar-actions label{display:flex;align-items:center;gap:4px;font-size:.8rem;cursor:pointer}
.settings-btn{background:transparent;color:var(--muted);border:1px solid var(--grid);padding:6px 10px;border-radius:8px;font-size:.8rem}
.settings-btn:hover{background:var(--bg)}

/* ===== MODE VIEWS ===== */
.mode-view{display:none;height:calc(100vh - 68px);padding:12px}
.mode-view.active{display:block}

/* ===== LESSON PLANNER LAYOUT ===== */
.lp-grid{display:grid;grid-template-columns:360px 1fr 320px;gap:12px;height:100%}
.panel{background:var(--panel);border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);padding:1.5rem;display:flex;flex-direction:column;min-height:0;overflow:auto;transition:background-color .3s;position:relative}
.panel h2{margin:.25rem 0 .5rem;font-size:1.125rem;font-weight:600}

/* Chat Panel */
#chat-panel{padding:0;display:flex;flex-direction:column}
#chat-header{padding:1rem 1.5rem .75rem;border-bottom:1px solid var(--grid)}
#chat-messages{flex:1;overflow-y:auto;padding:1rem 1.5rem;display:flex;flex-direction:column;gap:12px}
.chat-msg{max-width:92%;padding:10px 14px;border-radius:14px;font-size:.875rem;line-height:1.6;word-wrap:break-word}
.chat-msg.ai{align-self:flex-start;background:var(--bg);color:var(--ink);border-bottom-left-radius:4px}
.chat-msg.user{align-self:flex-end;background:var(--btn-primary-bg);color:var(--btn-primary-text);border-bottom-right-radius:4px}
.chat-msg h3{font-size:.9rem;font-weight:600;margin:0 0 .25rem}
.chat-msg p{margin:.25rem 0}
.chat-msg ul,.chat-msg ol{margin:.25rem 0;padding-left:1.25rem}
.chat-msg li{margin:.15rem 0}
.chat-msg strong{font-weight:600}
.chat-msg code{background:rgba(0,0,0,.08);padding:1px 4px;border-radius:4px;font-size:.8rem}
.chat-options{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chat-option{display:inline-flex;align-items:center;gap:4px;border:1px solid var(--grid);border-radius:999px;padding:6px 12px;background:var(--panel);cursor:pointer;font-size:.8rem;font-weight:500;color:var(--ink);transition:all .2s}
.chat-option:hover{border-color:var(--accent);background:var(--bg);color:var(--accent)}
.chat-typing{align-self:flex-start;color:var(--muted);font-size:.8rem;font-style:italic;padding:6px 14px}
#chat-input-row{padding:.75rem 1rem;border-top:1px solid var(--grid);display:flex;gap:8px;align-items:flex-end}
#chatInput{flex:1;border:1px solid var(--grid);border-radius:10px;padding:8px 12px;font:inherit;resize:none;min-height:40px;max-height:120px;background:var(--bg);color:var(--ink);box-sizing:border-box}
#chatSend{padding:8px 16px;background:var(--btn-primary-bg);color:var(--btn-primary-text);border:none;border-radius:10px;font-weight:600;cursor:pointer;white-space:nowrap;font-size:.875rem;align-self:flex-end}
#chatSend:hover{opacity:.9}
#chatSend:disabled{opacity:.5;cursor:not-allowed}

/* Plan Panel */
#plan-panel{padding:1.5rem}
.plan-empty{color:var(--muted);font-style:italic;text-align:center;margin-top:3rem}
.plan-section{border-left:3px solid var(--grid);padding-left:1rem;margin-bottom:1.5rem;transition:border-color .3s}
.plan-section.filled{border-left-color:var(--accent-2)}
.plan-section h3{font-size:.95rem;font-weight:600;margin:0 0 .5rem;display:flex;align-items:center;gap:6px}
.plan-section h3 .check{color:var(--accent-2);font-size:.8rem}
.plan-body{font-size:.875rem;line-height:1.6;color:var(--ink)}
.plan-body p{margin:.25rem 0}
.plan-body ul{margin:.25rem 0;padding-left:1.25rem}
.plan-body li{margin:.15rem 0}
.fw-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.fw-tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.7rem;font-weight:500}
.fw-tag.e21cc{background:#dbeafe;color:#1d4ed8}
.fw-tag.stp{background:#d1fae5;color:#059669}
.fw-tag.edtech{background:#fef3c7;color:#d97706}
.dark .fw-tag.e21cc{background:#1e3a8a;color:#93c5fd}
.dark .fw-tag.stp{background:#064e3b;color:#6ee7b7}
.dark .fw-tag.edtech{background:#78350f;color:#fcd34d}
.spatial-btn{display:inline-flex;align-items:center;gap:4px;margin-top:8px;padding:6px 12px;border:1px dashed var(--accent);border-radius:8px;background:transparent;color:var(--accent);cursor:pointer;font-size:.8rem;font-weight:500}
.spatial-btn:hover{background:var(--bg)}

/* Framework Panel */
#framework-panel{font-size:.8rem}
.fw-section{border-top:1px solid var(--grid);padding-top:.75rem;margin-top:.75rem}
.fw-section:first-child{border-top:none;margin-top:0;padding-top:0}
.fw-section-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:600;font-size:.85rem;padding:4px 0;user-select:none}
.fw-section-header::after{content:'\25B6';font-size:.6rem;transition:transform .2s}
.fw-section.open .fw-section-header::after{transform:rotate(90deg)}
.fw-section-body{display:none;padding:.5rem 0 .25rem}
.fw-section.open .fw-section-body{display:block}
.fw-domain{font-weight:600;font-size:.8rem;color:var(--accent);margin:.5rem 0 .25rem}
.fw-item{padding:3px 0 3px 12px;color:var(--ink);position:relative;font-size:.78rem}
.fw-item::before{content:'\2022';position:absolute;left:0;color:var(--muted)}
.fw-item.highlighted{background:#fffbeb;border-radius:4px;padding-left:12px}
.dark .fw-item.highlighted{background:#78350f33}

/* ===== SPATIAL PLANNER LAYOUT ===== */
.sp-grid{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;height:100%}
.section{margin-bottom:1.25rem;border-top:1px dashed var(--grid);padding-top:1.25rem}
.section:first-of-type{border-top:none;padding-top:0}
.chipbar{display:flex;gap:6px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--grid);border-radius:999px;padding:6px 10px;background:var(--bg);cursor:pointer;user-select:none;font-size:13px}
.chip .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.1)}
.hint{color:var(--muted);font-size:.75rem;margin-bottom:1rem;text-align:center}
.btnrow{display:flex;gap:8px;flex-wrap:wrap}
button{border:none;border-radius:12px;padding:12px 16px;background:#111827;color:#fff;cursor:pointer;transition:background-color .2s;font-weight:500;white-space:nowrap;font-size:14px}
button:hover{background:#374151}
button:disabled{background:#9ca3af;cursor:not-allowed}
button.primary{background:var(--btn-primary-bg);color:var(--btn-primary-text)}
button.primary:hover{background:var(--accent-dark)}
.dark button.primary:hover{background:#d3be00}
button.secondary{background:#e5e7eb;color:#111827}
button.secondary:hover{background:#d1d5db}
.dark button.secondary{background:#4b5563;color:#f9fafb}
.dark button.secondary:hover{background:#6b7280}
button.ghost{background:transparent;color:var(--ink);border:1px solid var(--grid)}
button.ghost:hover{background:var(--bg)}
button.danger{background:var(--danger)}
button.danger:hover{background:#b91c1c}
label.toggle{display:flex;align-items:center;gap:8px;font-weight:500;margin:8px 0}
select,input[type="text"],input[type="password"],textarea{width:100%;border:1px solid var(--grid);border-radius:8px;padding:6px 8px;font:inherit;box-sizing:border-box;background:var(--bg);color:var(--ink)}

.stage-wrap{position:relative;background:var(--panel);border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);padding:10px;min-height:0}
#stage{width:100%;height:calc(100vh - 112px);background:var(--panel);border-radius:12px;-webkit-tap-highlight-color:transparent}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
.toolbar .left,.toolbar .right{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:var(--bg);border:1px solid var(--grid);border-radius:6px;padding:2px 6px;font-size:12px}
.legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap}
.legend .tag{display:inline-flex;align-items:center;gap:6px}
.tag .swatch{width:10px;height:10px;border-radius:2px}
.toast{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:#111827;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;opacity:.95;display:none;z-index:100}
.insight-group{border-left:3px solid var(--grid);padding-left:1rem;transition:border-color .3s}
.insight-group:hover{border-left-color:var(--accent-2)}
.insight-title{font-size:1rem;font-weight:600;color:var(--ink);margin-bottom:.5rem}
.insight-subtitle{font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-top:.75rem;margin-bottom:.25rem}
.insight-text{font-size:.875rem;color:var(--ink);line-height:1.5}
.insight-list{list-style-type:none;padding-left:0;font-size:.875rem;color:var(--ink);display:flex;flex-direction:column;gap:.75rem}
.insight-list li{position:relative;padding-left:1.25rem}
.insight-list li::before{content:'\2713';position:absolute;left:0;color:var(--accent-2);font-weight:600}
.scene-list{display:flex;flex-direction:column;gap:6px;overflow:auto}
.scene-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--grid);border-radius:10px;padding:6px 8px}
.scene-item input{width:100px}
.scene-actions{display:flex;gap:6px}
.ow-panel{cursor:grab}
.ghost-snap{fill:none;stroke:#6366f1;stroke-width:2;stroke-dasharray:6 6;pointer-events:none;opacity:.9}
.ghost-snap text{fill:#6366f1;font-size:10px}
.handle{pointer-events:all}
.togglebox{display:flex;align-items:center;gap:8px}
.muted{color:var(--muted)}
.selection{pointer-events:none}
.marquee{fill:rgba(59,130,246,.08);stroke:#3b82f6;stroke-dasharray:4 4;stroke-width:1;pointer-events:none}
svg :focus{outline:none}
.text-label-bg{stroke:var(--muted);stroke-width:1;stroke-dasharray:2 2;fill:rgba(243,244,246,.7)}
.dark .text-label-bg{fill:rgba(55,65,81,.7)}
.text-label-text{font-size:14px;font-family:'Inter',sans-serif;fill:var(--ink)}
.text-edit-foreign-object{overflow:visible}
.text-edit-textarea{background:var(--panel);border:1px solid var(--accent);color:var(--ink);padding:4px;font-family:inherit;font-size:14px;width:100%;height:100%;box-sizing:border-box;resize:none;border-radius:4px}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:200}
.modal-content{background:var(--panel);color:var(--ink);padding:1.5rem;border-radius:1rem;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);width:90%;max-width:400px}
.modal-content h3{font-size:1.125rem;font-weight:600;margin-top:0;margin-bottom:1rem}
.modal-content input{margin-bottom:1rem}
#chartTooltip{position:absolute;display:none;background:rgba(0,12,83,.9);color:#fff;border-radius:.75rem;padding:.75rem;font-size:.75rem;pointer-events:none;z-index:10;width:200px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);line-height:1.4}
.dark #chartTooltip{background:rgba(255,226,0,.9);color:#000C53}
#chartTooltip h4{margin:0 0 .5rem;font-weight:600;font-size:.875rem}
#chartTooltip p{margin:0 0 .5rem}
#chartTooltip .reading{font-style:italic;opacity:.9}
</style>
</head>
<body>

<!-- ==================== WELCOME SCREEN ==================== -->
<div id="welcome">
  <div class="welcome-card">
    <h1>Co-Cher</h1>
    <p class="subtitle">Your lesson planning &amp; spatial design companion</p>
    <div class="tagline">Aligned to Singapore MOE Frameworks</div>
    <label for="apiKeyInput">Gemini API Key</label>
    <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API key here">
    <div class="key-help">
      Your key is stored only in your browser, never sent anywhere except Google's API.
      <br><a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Get a free Gemini API key here</a>
    </div>
    <div id="keyStatus" style="display:none;padding:8px 12px;border-radius:8px;font-size:.8rem;margin-bottom:1rem;text-align:left"></div>
    <button class="start-btn" id="getStarted">Get Started</button>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="app" style="display:none">

  <!-- Topbar -->
  <header id="topbar">
    <div class="brand">Co-Cher</div>
    <nav class="mode-tabs">
      <button class="mode-tab active" data-mode="lesson">Lesson Planner</button>
      <button class="mode-tab" data-mode="spatial">Spatial Designer</button>
    </nav>
    <div class="topbar-actions">
      <label><input type="checkbox" id="toggleDarkMode"> Dark</label>
      <button class="settings-btn" id="settingsBtn">Settings</button>
    </div>
  </header>

  <!-- ==================== LESSON PLANNER MODE ==================== -->
  <div id="lesson-mode" class="mode-view active">
    <div class="lp-grid">

      <!-- Left: Chat -->
      <aside class="panel" id="chat-panel">
        <div id="chat-header"><h2>Co-Cher Assistant</h2></div>
        <div id="chat-messages"></div>
        <div id="chat-input-row">
          <textarea id="chatInput" rows="2" placeholder="Tell Co-Cher about your lesson..."></textarea>
          <button id="chatSend">Send</button>
        </div>
      </aside>

      <!-- Center: Lesson Plan -->
      <main class="panel" id="plan-panel">
        <h2>Lesson Plan</h2>
        <div id="plan-content">
          <p class="plan-empty">Your lesson plan will build here as you chat with Co-Cher.</p>
        </div>
      </main>

      <!-- Right: Framework Reference -->
      <aside class="panel" id="framework-panel">
        <h2>MOE Frameworks</h2>
        <div id="framework-sidebar"></div>
      </aside>

    </div>
  </div>

  <!-- ==================== SPATIAL PLANNER MODE ==================== -->
  <div id="spatial-mode" class="mode-view">
    <div class="sp-grid">

      <!-- Left: Palette -->
      <aside class="panel" id="palette">
        <div class="section">
          <h2>AI Layout Assistant</h2>
          <p class="hint">Describe your lesson for an AI-suggested layout.</p>
          <textarea id="llm-prompt">I am planning a lesson for [28] students. The main activity is [collaborative problem-solving in small groups] to develop [critical thinking and communication skills]. Please suggest an appropriate classroom layout.</textarea>
          <button id="llm-generate-btn" class="primary mt-2 w-full">Generate Layout</button>
        </div>
        <div class="section">
          <h2>Item Library</h2>
          <div class="hint">Click to add. Drag to place. <span class="kbd">Shift</span> multi-select. <span class="kbd">R</span> rotate. <span class="kbd">Del</span> delete. Hold <span class="kbd">Alt</span> = bypass snap.</div>
        </div>
        <div class="section"><strong>Furniture</strong><div class="chipbar" id="chips-furniture"></div></div>
        <div class="section"><strong>Tech</strong><div class="chipbar" id="chips-tech"></div></div>
        <div class="section"><strong>Cognitive Tools</strong><div class="chipbar" id="chips-cognitive"></div></div>
        <div class="section"><strong>Social Furniture</strong><div class="chipbar" id="chips-social"></div></div>
        <div class="section"><strong>Wellbeing Items</strong><div class="chipbar" id="chips-emotional"></div></div>
        <div class="section"><strong>Stations (coloured desks)</strong><div class="chipbar" id="chips-stations"></div></div>
        <div class="section"><strong>Zones &amp; Annotations</strong>
          <div class="hint">Zones are overlays. Text labels are for annotation.</div>
          <div class="chipbar" id="chips-zones"></div>
        </div>
        <div class="section">
          <div class="togglebox"><label class="toggle"><input type="checkbox" id="toggleWall" checked> Show operable walls</label></div>
          <div class="togglebox"><label class="toggle"><input type="checkbox" id="toggleSnap" checked> Snap enabled</label><span class="muted">(hold Alt to bypass)</span></div>
          <div class="btnrow mt-4">
            <button id="btnExport" class="primary">Export PNG</button>
            <button class="primary" id="btnClear">Clear</button>
          </div>
          <div class="btnrow mt-2">
            <button class="primary" id="btnCloseA">Close A</button>
            <button class="primary" id="btnCloseB">Close B</button>
            <button class="primary" id="btnStackA">A: Stack 4+4</button>
            <button class="primary" id="btnStackB">B: Stack 4+4</button>
          </div>
        </div>
      </aside>

      <!-- Center: SVG Canvas -->
      <main class="stage-wrap">
        <div class="toolbar">
          <div class="left legend">
            <span class="tag"><span class="swatch" style="background:#93c5fd"></span> Cognitive</span>
            <span class="tag"><span class="swatch" style="background:#a7f3d0"></span> Social</span>
            <span class="tag"><span class="swatch" style="background:#fde68a"></span> Emotional</span>
            <span class="tag"><span class="swatch" style="background:var(--door)"></span> Door</span>
            <span class="tag"><span class="swatch" style="background:var(--window)"></span> Windows</span>
            <span class="tag"><span class="swatch" style="background:#9ca3af"></span> Operable walls</span>
            <label class="toggle"><input type="checkbox" id="toggleLegend" checked> Legend</label>
          </div>
          <div class="right">
            <div class="togglebox">
              <label>Preset</label>
              <select id="presetSelect">
                <option value="">-- Select --</option>
                <optgroup label="Standard Presets">
                  <option value="direct">Direct Instruction</option>
                  <option value="pods">Group Pods (4-6)</option>
                  <option value="stations">Stations / Rotations</option>
                  <option value="circle">Discussion Circle / U</option>
                  <option value="quiet">Quiet Work</option>
                  <option value="maker">Makerspace</option>
                  <option value="fishbowl">Fishbowl / Socratic</option>
                  <option value="gallery">Gallery Walk</option>
                </optgroup>
                <optgroup label="Custom Presets" id="customPresetGroup"></optgroup>
              </select>
              <button class="ghost" id="applyPreset">Apply</button>
              <button class="ghost" id="saveCustomPreset">Save custom</button>
            </div>
          </div>
        </div>
        <svg id="stage" viewBox="0 0 1440 720" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern id="grid" width="60" height="60" patternUnits="userSpaceOnUse">
              <rect width="60" height="60" fill="var(--panel)"/>
              <path d="M60 0V60 M0 60H60" stroke="var(--grid)" stroke-width="1"/>
            </pattern>
            <filter id="elev" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.25"/>
            </filter>
            <linearGradient id="deskGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#ffffff" stop-opacity="0.6"/>
              <stop offset="100%" stop-color="#000000" stop-opacity="0.05"/>
            </linearGradient>
          </defs>
          <rect id="roomA" x="0" y="0" width="720" height="720" fill="url(#grid)"/>
          <line id="trackA" x1="720" y1="0" x2="720" y2="720" stroke="#9ca3af" stroke-width="2" stroke-dasharray="6 6" opacity="0.35"/>
          <line id="trackB" x1="1080" y1="0" x2="1080" y2="720" stroke="#9ca3af" stroke-width="2" stroke-dasharray="6 6" opacity="0.35"/>
          <rect id="roomB" x="720" y="0" width="720" height="720" fill="url(#grid)" opacity="0.08"/>
          <g id="items"><g id="layoutRoot"></g></g>
          <g id="operableWalls"><g id="wallA" data-x="720"></g><g id="wallB" data-x="1080"></g></g>
          <g id="ghost"></g>
          <rect id="marquee" class="marquee" x="0" y="0" width="0" height="0" style="display:none"/>
          <g id="shell">
            <rect x="0" y="0" width="1440" height="720" fill="none" stroke="var(--ink)" stroke-width="8"/>
            <text id="frontLabel" x="50" y="22" font-size="14" font-family="system-ui" fill="var(--ink)">FRONT</text>
            <rect id="doorTopA" x="300" y="-1" width="60" height="10" fill="var(--door)"/>
            <rect id="doorTopB" x="1000" y="-1" width="60" height="10" fill="var(--door)"/>
            <rect id="winTop1" x="130" y="-1" width="560" height="10" fill="var(--window)"/>
            <rect id="winTop2" x="780" y="-1" width="560" height="10" fill="var(--window)"/>
            <rect id="winBot1" x="130" y="711" width="560" height="10" fill="var(--window)"/>
            <rect id="winBot2" x="780" y="711" width="560" height="10" fill="var(--window)"/>
          </g>
        </svg>
        <div class="toast" id="toast"></div>
      </main>

      <!-- Right: Insights -->
      <aside class="panel" id="right-panel">
        <div class="section"><h2>Spatial Effectiveness Profile</h2><canvas id="spatialEffectivenessChart"></canvas></div>
        <div class="section" id="pedagogyInsights"><h2>Pedagogical Opportunities</h2><div id="insightsContainer" class="flex flex-col gap-6"></div></div>
        <div class="section"><h2>Scenes (Lesson Timeline)</h2><div class="btnrow"><input id="sceneName" type="text" placeholder="Scene name (e.g., Warm-up)"><button id="saveScene" class="primary">Save current</button></div><div class="scene-list mt-2" id="sceneList"></div></div>
        <div id="chartTooltip"></div>
      </aside>

    </div>
  </div>

</div>

<!-- ==================== MODALS ==================== -->
<div id="settingsModal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <h3>Settings</h3>
    <label style="font-weight:600;font-size:.875rem">Gemini API Key</label>
    <input type="password" id="settingsApiKey" placeholder="Your API key">
    <label style="font-weight:600;font-size:.875rem">Model</label>
    <select id="settingsModel" style="margin-bottom:1rem">
      <option value="gemini-2.5-flash">Gemini 2.5 Flash (Recommended)</option>
      <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash Preview</option>
      <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
    </select>
    <div id="settingsKeyStatus" style="display:none;padding:8px 12px;border-radius:8px;font-size:.8rem;margin-bottom:1rem"></div>
    <div class="btnrow">
      <button class="ghost" id="settingsTestKey">Test Key</button>
      <button class="primary" id="settingsSave">Save</button>
      <button class="secondary" id="settingsCancel">Cancel</button>
    </div>
  </div>
</div>

<div id="savePresetModal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <h3>Save Custom Preset</h3>
    <input type="text" id="customPresetNameInput" placeholder="Enter preset name...">
    <div class="btnrow">
      <button id="confirmSavePreset" class="primary">Save</button>
      <button id="cancelSavePreset" class="secondary">Cancel</button>
    </div>
  </div>
</div>


<script>
(function(){
// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 1: SINGAPORE MOE FRAMEWORK DATA                       ║
// ╚══════════════════════════════════════════════════════════════════╝

const FRAMEWORKS = {
  e21cc: {
    label: 'E21CC (Refreshed 2023)',
    coreValues: ['Respect','Responsibility','Resilience','Integrity','Care','Harmony'],
    sel: ['Self-Awareness','Self-Management','Social Awareness','Relationship Management','Responsible Decision-Making'],
    domains: {
      CAIT: {
        label: 'Critical, Adaptive & Inventive Thinking',
        competencies: {
          'Critical Thinking': 'Exercise sound reasoning and metacognitive thinking to interpret and analyse information, draw conclusions, make decisions, and solve problems.',
          'Adaptive Thinking': 'Apply learnt knowledge and skills strategically and with flexibility in different or new and evolving contexts.',
          'Inventive Thinking': 'Frame, investigate and explore issues, generate innovative ideas, and evaluate them to form novel and useful responses.'
        }
      },
      CCI: {
        label: 'Communication, Collaboration & Information Skills',
        competencies: {
          'Effective Communication': 'Convey information and exchange ideas clearly and coherently through multimodal ways for specific purposes, audiences and contexts.',
          'Collaboration': 'Work cohesively in teams towards shared goals.',
          'Information Skills': 'Manage, create and share information thoughtfully, ethically and responsibly.'
        }
      },
      CGC: {
        label: 'Civic, Global & Cross-Cultural Literacy',
        competencies: {
          'Civic Literacy': 'Understand the nation\'s values, governance, context and realities, form civic identity, and constructively contribute to community and nation.',
          'Global Literacy': 'Understand and think with discernment about world issues and interact responsibly with people from and beyond Singapore.',
          'Cross-Cultural Literacy': 'Sensitively understand, appreciate and interact with different social, cultural and religious communities and their perspectives.'
        }
      }
    },
    outcomes: ['Confident Person','Self-Directed Learner','Active Contributor','Concerned Citizen']
  },
  stp: {
    label: 'Singapore Teaching Practice',
    processes: {
      'Lesson Preparation': ['Determining Learning Objectives','Considering Learners\' Profiles','Selecting & Sequencing Content','Deciding on Teaching Approach','Planning Assessment','Sequencing Learning'],
      'Lesson Enactment': ['Activating Prior Knowledge','Arousing Interest','Providing Clear Explanation','Pacing & Maintaining Momentum','Exercising Flexibility','Using Questioning to Deepen Learning','Using Representations','Facilitating Collaborative Learning','Managing Transitions','Consolidating Learning','Differentiating Instruction'],
      'Positive Classroom Culture': ['Establishing Interaction & Rapport','Building Trust','Setting Expectations & Routines','Building a Safe & Supportive Environment'],
      'Assessment & Feedback': ['Checking for Understanding','Providing Feedback','Setting Meaningful Assignments','Monitoring & Reviewing Student Learning']
    }
  },
  edtech: {
    label: 'EdTech Masterplan 2030',
    thrusts: ['Customise Learning','Digital Literacy & Technological Skills','21CC Enablement via Technology','Culture of Collaboration'],
    digitalCompetencies: {
      'Digital Safety & Security': 'Understanding of online behaviour and how to protect oneself online.',
      'Digital Responsibility': 'Respect for oneself and others; safe, responsible, ethical use.',
      'Digital Knowledge Currency': 'Keep up-to-date with technological developments as part of learning for life.',
      'Computational Thinking': 'Employ computational thinking with technological tools to solve problems.',
      'Digital Information Management': 'Locate information and evaluate accuracy, credibility, and relevance.',
      'Digital Communication & Collaboration': 'Leverage digital platforms to communicate ideas and contribute to a common goal.',
      'Data Competencies': 'Read, understand, interpret, manipulate, analyse, and present data meaningfully.',
      'Device & Software Operations': 'Understand how devices and software work to use them effectively.',
      'Coding & Programming': 'Utilise digital methods like block/text-based programming or prompt engineering to create digital artefacts.'
    }
  }
};

// System prompt for Gemini AI
const SYSTEM_PROMPT = `You are Co-Cher, a Singapore MOE-aligned pedagogical assistant. You help teachers plan lessons that develop students' 21st Century Competencies through thoughtful spatial design and pedagogical strategies.

## YOUR FRAMEWORK KNOWLEDGE

### E21CC (Emerging 21st Century Competencies — Refreshed 2023)
Three domains with 9 sub-competencies:
CAIT (Critical, Adaptive & Inventive Thinking): Critical Thinking, Adaptive Thinking, Inventive Thinking
CCI (Communication, Collaboration & Information Skills): Effective Communication, Collaboration, Information Skills
CGC (Civic, Global & Cross-Cultural Literacy): Civic Literacy, Global Literacy, Cross-Cultural Literacy
Core Values: Respect, Responsibility, Resilience, Integrity, Care, Harmony
SEL: Self-Awareness, Self-Management, Social Awareness, Relationship Management, Responsible Decision-Making
Desired Outcomes: Confident Person, Self-Directed Learner, Active Contributor, Concerned Citizen

### STP (Singapore Teaching Practice)
4 Teaching Processes with 25 Teaching Areas:
LESSON PREPARATION: Determining Learning Objectives, Considering Learners' Profiles, Selecting & Sequencing Content, Deciding on Teaching Approach, Planning Assessment, Sequencing Learning
LESSON ENACTMENT: Activating Prior Knowledge, Arousing Interest, Providing Clear Explanation, Pacing & Maintaining Momentum, Exercising Flexibility, Using Questioning to Deepen Learning, Using Representations, Facilitating Collaborative Learning, Managing Transitions, Consolidating Learning, Differentiating Instruction
POSITIVE CLASSROOM CULTURE: Establishing Interaction & Rapport, Building Trust, Setting Expectations & Routines, Building a Safe & Supportive Environment
ASSESSMENT & FEEDBACK: Checking for Understanding, Providing Feedback, Setting Meaningful Assignments, Monitoring & Reviewing Student Learning

### EdTech Masterplan 2030
Strategic Thrusts: Customise Learning, DLTS, 21CC Enablement, Collaboration Culture
9 Digital Competencies: Digital Safety & Security, Digital Responsibility, Digital Knowledge Currency, Computational Thinking, Digital Information Management, Digital Communication & Collaboration, Data Competencies, Device & Software Operations, Coding & Programming

## RESPONSE FORMAT
Respond ONLY with valid JSON:
{
  "message": "Your conversational response (use **bold**, *italic*, bullet lists with - prefix)",
  "options": [{"label":"text","icon":"emoji","value":"id"}],
  "plan": {"section":"section_name","content":"markdown content for this section"},
  "frameworks": {"e21cc":["names"],"stp":["names"],"edtech":["names"]},
  "spatial": "preset_name_or_null"
}

All fields except "message" are optional. Include "options" (2-4 items) when the teacher needs to choose. Include "plan" when adding to the lesson plan. Plan sections: context, objectives, e21cc_focus, hook, activities, essential_questions, enduring_understandings, spatial, assessment.

Spatial presets: direct, pods, stations, circle, quiet, maker, fishbowl, gallery.

## LESSON PLANNING APPROACH
Guide teachers step by step. For each lesson, help them develop:
1. **Lesson Context** — subject, topic, grade, duration, student count
2. **Learning Objectives** mapped to E21CC competencies
3. **Lesson Hook** — offer types: Interesting Fact, Cognitive Dissonance, Story/Anecdote, Joke/Humour, Visual/Demo, Mystery/Question
4. **Activities with Phasing** — suggest phases (e.g. Hook, Explore, Explain, Elaborate, Evaluate) with spatial layout for each
5. **Essential Questions & Enduring Understandings** — big ideas students should grasp
6. **E21CC Foregrounding** — which competencies to explicitly develop
7. **Assessment** — offer types: Exit Ticket, Think-Pair-Share, Gallery Walk Critique, Quick Write, Peer Assessment, Self-Assessment Rubric

Keep suggestions practical, classroom-ready for Singapore schools. Reference specific framework elements by name. Prevent choice paralysis: offer focused menus of 2-4 options.`;


// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 2: APP STATE & DOM REFERENCES                          ║
// ╚══════════════════════════════════════════════════════════════════╝

let apiKey = localStorage.getItem('cocher_api_key') || '';
// Migrate away from deprecated gemini-2.0-flash model
if (localStorage.getItem('cocher_model') === 'gemini-2.0-flash') {
  localStorage.setItem('cocher_model', 'gemini-2.5-flash');
}
let geminiModel = localStorage.getItem('cocher_model') || 'gemini-2.5-flash';
let chatHistory = [];
let currentMode = 'lesson';
let isGenerating = false;

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 3: WELCOME SCREEN & SETTINGS                          ║
// ╚══════════════════════════════════════════════════════════════════╝

async function testApiKey(key, model) {
  model = model || geminiModel || 'gemini-2.5-flash';
  var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + key;
  var payload = {
    contents: [{ role: 'user', parts: [{ text: 'Reply with exactly: OK' }] }],
    generationConfig: { maxOutputTokens: 10 }
  };
  var resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  if (!resp.ok) {
    var body = await resp.text();
    if (resp.status === 400) throw new Error('Invalid API key format. Check that you copied the full key.');
    if (resp.status === 403) throw new Error('API key is valid but lacks permission. Enable "Generative Language API" in Google Cloud Console.');
    if (resp.status === 429) throw new Error('Rate limited. Your key works but has hit its quota. Wait a moment and try again.');
    throw new Error('API returned ' + resp.status + ': ' + body.substring(0, 150));
  }
  var data = await resp.json();
  if (!data.candidates || !data.candidates.length) throw new Error('Unexpected response format. The model may not be available.');
  return true;
}

function showKeyStatus(msg, isError) {
  var el = document.getElementById('keyStatus');
  el.style.display = 'block';
  el.style.background = isError ? '#fef2f2' : '#f0fdf4';
  el.style.color = isError ? '#991b1b' : '#166534';
  el.style.border = '1px solid ' + (isError ? '#fecaca' : '#bbf7d0');
  el.textContent = msg;
}

function initWelcome() {
  if (apiKey) {
    document.getElementById('welcome').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
    return;
  }
  document.getElementById('getStarted').addEventListener('click', async function() {
    var btn = document.getElementById('getStarted');
    var key = document.getElementById('apiKeyInput').value.trim();
    if (!key) { showKeyStatus('Please enter your Gemini API key.', true); return; }
    btn.textContent = 'Testing key...'; btn.disabled = true;
    try {
      await testApiKey(key);
      showKeyStatus('Key verified successfully!', false);
      apiKey = key;
      localStorage.setItem('cocher_api_key', apiKey);
      setTimeout(function() {
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        initApp();
      }, 600);
    } catch(err) {
      showKeyStatus(err.message, true);
      btn.textContent = 'Get Started'; btn.disabled = false;
    }
  });
  document.getElementById('apiKeyInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('getStarted').click();
  });
}

function openSettings() {
  document.getElementById('settingsApiKey').value = apiKey;
  document.getElementById('settingsModel').value = geminiModel;
  document.getElementById('settingsModal').style.display = 'flex';
}
function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 4: MODE SWITCHING                                      ║
// ╚══════════════════════════════════════════════════════════════════╝

function switchMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-view').forEach(function(v) { v.classList.remove('active'); });
  document.querySelectorAll('.mode-tab').forEach(function(t) { t.classList.remove('active'); });
  document.getElementById(mode + '-mode').classList.add('active');
  document.querySelector('[data-mode="' + mode + '"]').classList.add('active');
  if (mode === 'spatial' && !spatialInitialized) { initSpatialPlanner(); spatialInitialized = true; }
}

function switchToSpatialWithPreset(presetName) {
  switchMode('spatial');
  if (!spatialInitialized) { initSpatialPlanner(); spatialInitialized = true; }
  setTimeout(function() { applyPreset(presetName, 28); }, 100);
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 5: SIMPLE MARKDOWN RENDERER                            ║
// ╚══════════════════════════════════════════════════════════════════╝

function renderMd(text) {
  if (!text) return '';
  var html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>');
  // Convert bullet lists
  var lines = html.split('\n');
  var out = [], inList = false;
  lines.forEach(function(line) {
    var trimmed = line.trim();
    if (/^[-•]\s/.test(trimmed)) {
      if (!inList) { out.push('<ul>'); inList = true; }
      out.push('<li>' + trimmed.replace(/^[-•]\s*/, '') + '</li>');
    } else if (/^\d+\.\s/.test(trimmed)) {
      if (!inList) { out.push('<ol>'); inList = true; }
      out.push('<li>' + trimmed.replace(/^\d+\.\s*/, '') + '</li>');
    } else {
      if (inList) { out.push('</ul>'); inList = false; }
      if (trimmed === '') out.push('');
      else out.push('<p>' + trimmed + '</p>');
    }
  });
  if (inList) out.push('</ul>');
  return out.join('');
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 6: CHAT ENGINE (Gemini API)                            ║
// ╚══════════════════════════════════════════════════════════════════╝

function addChatMessage(role, html, options, spatialPreset) {
  var container = document.getElementById('chat-messages');
  var msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg ' + role;
  msgDiv.innerHTML = html;
  container.appendChild(msgDiv);

  if (options && options.length > 0) {
    var optBar = document.createElement('div');
    optBar.className = 'chat-options';
    options.forEach(function(opt) {
      var btn = document.createElement('button');
      btn.className = 'chat-option';
      btn.textContent = (opt.icon || '') + ' ' + opt.label;
      btn.addEventListener('click', function() {
        optBar.querySelectorAll('.chat-option').forEach(function(b) { b.disabled = true; b.style.opacity = '0.5'; });
        btn.style.opacity = '1'; btn.style.borderColor = 'var(--accent)';
        sendUserMessage(opt.label);
      });
      optBar.appendChild(btn);
    });
    container.appendChild(optBar);
  }

  if (spatialPreset) {
    var spatBtn = document.createElement('button');
    spatBtn.className = 'spatial-btn';
    spatBtn.innerHTML = 'Open in Spatial Designer &rarr; (' + spatialPreset + ')';
    spatBtn.addEventListener('click', function() { switchToSpatialWithPreset(spatialPreset); });
    container.appendChild(spatBtn);
  }

  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  var container = document.getElementById('chat-messages');
  var el = document.createElement('div');
  el.className = 'chat-typing';
  el.id = 'typing-indicator';
  el.textContent = 'Co-Cher is thinking...';
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}
function hideTyping() {
  var el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

function updateLessonPlan(section, content, frameworks) {
  var planContent = document.getElementById('plan-content');
  var empty = planContent.querySelector('.plan-empty');
  if (empty) empty.remove();

  var sectionLabels = {
    context: 'Lesson Context', objectives: 'Learning Objectives', e21cc_focus: 'E21CC Focus',
    hook: 'Lesson Hook', activities: 'Lesson Activities & Phasing',
    essential_questions: 'Essential Questions', enduring_understandings: 'Enduring Understandings',
    spatial: 'Spatial Layout Recommendation', assessment: 'Assessment for Understanding'
  };

  var el = planContent.querySelector('[data-section="' + section + '"]');
  if (!el) {
    el = document.createElement('div');
    el.className = 'plan-section filled';
    el.setAttribute('data-section', section);
    planContent.appendChild(el);
  } else {
    el.classList.add('filled');
  }

  var tagsHtml = '';
  if (frameworks) {
    var tags = [];
    if (frameworks.e21cc) frameworks.e21cc.forEach(function(t) { tags.push('<span class="fw-tag e21cc">' + t + '</span>'); });
    if (frameworks.stp) frameworks.stp.forEach(function(t) { tags.push('<span class="fw-tag stp">' + t + '</span>'); });
    if (frameworks.edtech) frameworks.edtech.forEach(function(t) { tags.push('<span class="fw-tag edtech">' + t + '</span>'); });
    if (tags.length) tagsHtml = '<div class="fw-tags">' + tags.join('') + '</div>';
  }

  el.innerHTML = '<h3><span class="check">&#10003;</span> ' + (sectionLabels[section] || section) + '</h3><div class="plan-body">' + renderMd(content) + '</div>' + tagsHtml;
  highlightFrameworks(frameworks);
}

function highlightFrameworks(frameworks) {
  document.querySelectorAll('.fw-item.highlighted').forEach(function(el) { el.classList.remove('highlighted'); });
  if (!frameworks) return;
  var allNames = [].concat(frameworks.e21cc || [], frameworks.stp || [], frameworks.edtech || []);
  allNames.forEach(function(name) {
    document.querySelectorAll('.fw-item').forEach(function(el) {
      if (el.textContent.trim() === name) el.classList.add('highlighted');
    });
  });
}

async function sendUserMessage(text) {
  if (!text.trim() || isGenerating) return;
  isGenerating = true;
  document.getElementById('chatSend').disabled = true;
  document.getElementById('chatInput').value = '';

  addChatMessage('user', '<p>' + text.replace(/</g,'&lt;') + '</p>');
  chatHistory.push({ role: 'user', parts: [{ text: text }] });

  showTyping();
  try {
    var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + geminiModel + ':generateContent?key=' + apiKey;
    var payload = {
      systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents: chatHistory,
      generationConfig: { responseMimeType: 'application/json', temperature: 0.8, maxOutputTokens: 4096 }
    };
    var resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!resp.ok) {
      var errText = await resp.text();
      if (resp.status === 400) throw new Error('Bad request — your API key may be invalid or the model "' + geminiModel + '" may not be available. Try changing the model in Settings.');
      if (resp.status === 403) throw new Error('Permission denied — your API key lacks access. Enable "Generative Language API" in Google Cloud Console.');
      if (resp.status === 429) throw new Error('Rate limited — you\'ve hit your API quota. Wait a minute and try again, or check your quota at console.cloud.google.com.');
      throw new Error('API error ' + resp.status + ': ' + errText.substring(0, 200));
    }
    var data = await resp.json();
    var rawText = data.candidates[0].content.parts[0].text;
    chatHistory.push({ role: 'model', parts: [{ text: rawText }] });

    var parsed;
    try { parsed = JSON.parse(rawText); } catch(e) {
      hideTyping();
      addChatMessage('ai', '<p>' + renderMd(rawText) + '</p>');
      isGenerating = false; document.getElementById('chatSend').disabled = false;
      return;
    }

    hideTyping();
    addChatMessage('ai', renderMd(parsed.message), parsed.options || null, parsed.spatial || null);
    if (parsed.plan && parsed.plan.section && parsed.plan.content) {
      updateLessonPlan(parsed.plan.section, parsed.plan.content, parsed.frameworks);
    } else if (parsed.frameworks) {
      highlightFrameworks(parsed.frameworks);
    }
  } catch(err) {
    hideTyping();
    addChatMessage('ai', '<p style="color:var(--danger)"><strong>Error:</strong> ' + err.message + '</p><p>You can test your API key via the <strong>Settings</strong> button (top right) &rarr; <strong>Test Key</strong>.</p>');
  }
  isGenerating = false;
  document.getElementById('chatSend').disabled = false;
}

function sendWelcomeMessage() {
  addChatMessage('ai',
    '<h3>Welcome! I\'m Co-Cher</h3>' +
    '<p>Your lesson planning companion, aligned to <strong>E21CC</strong>, <strong>STP</strong>, and <strong>EdTech Masterplan 2030</strong>.</p>' +
    '<p>I\'ll help you design a lesson with:</p>' +
    '<ul><li>A compelling <strong>lesson hook</strong></li>' +
    '<li>Phased <strong>activities</strong> with spatial layout suggestions</li>' +
    '<li><strong>Essential questions</strong> &amp; enduring understandings</li>' +
    '<li><strong>E21CC competencies</strong> to foreground</li>' +
    '<li><strong>Assessment</strong> ideas to check for understanding</li></ul>' +
    '<p>Let\'s get started! What are you teaching?</p>',
    [
      { label: 'English Language', icon: '\uD83D\uDCDD', value: 'english' },
      { label: 'Mathematics', icon: '\uD83D\uDD22', value: 'math' },
      { label: 'Science', icon: '\uD83D\uDD2C', value: 'science' },
      { label: 'Humanities', icon: '\uD83C\uDF0D', value: 'humanities' }
    ]
  );
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 7: FRAMEWORK SIDEBAR                                   ║
// ╚══════════════════════════════════════════════════════════════════╝

function renderFrameworkSidebar() {
  var sidebar = document.getElementById('framework-sidebar');
  var html = '';

  // E21CC
  html += '<div class="fw-section open"><div class="fw-section-header">E21CC (Refreshed 2023)</div><div class="fw-section-body">';
  html += '<div class="fw-domain">Core Values</div>';
  FRAMEWORKS.e21cc.coreValues.forEach(function(v) { html += '<div class="fw-item">' + v + '</div>'; });
  html += '<div class="fw-domain">Social-Emotional Competencies</div>';
  FRAMEWORKS.e21cc.sel.forEach(function(v) { html += '<div class="fw-item">' + v + '</div>'; });
  Object.keys(FRAMEWORKS.e21cc.domains).forEach(function(key) {
    var d = FRAMEWORKS.e21cc.domains[key];
    html += '<div class="fw-domain">' + d.label + '</div>';
    Object.keys(d.competencies).forEach(function(c) { html += '<div class="fw-item" title="' + d.competencies[c].replace(/"/g,'&quot;') + '">' + c + '</div>'; });
  });
  html += '<div class="fw-domain">Desired Outcomes</div>';
  FRAMEWORKS.e21cc.outcomes.forEach(function(v) { html += '<div class="fw-item">' + v + '</div>'; });
  html += '</div></div>';

  // STP
  html += '<div class="fw-section"><div class="fw-section-header">Singapore Teaching Practice</div><div class="fw-section-body">';
  Object.keys(FRAMEWORKS.stp.processes).forEach(function(proc) {
    html += '<div class="fw-domain">' + proc + '</div>';
    FRAMEWORKS.stp.processes[proc].forEach(function(area) { html += '<div class="fw-item">' + area + '</div>'; });
  });
  html += '</div></div>';

  // EdTech
  html += '<div class="fw-section"><div class="fw-section-header">EdTech Masterplan 2030</div><div class="fw-section-body">';
  html += '<div class="fw-domain">Strategic Thrusts</div>';
  FRAMEWORKS.edtech.thrusts.forEach(function(t) { html += '<div class="fw-item">' + t + '</div>'; });
  html += '<div class="fw-domain">Digital Competencies</div>';
  Object.keys(FRAMEWORKS.edtech.digitalCompetencies).forEach(function(c) {
    html += '<div class="fw-item" title="' + FRAMEWORKS.edtech.digitalCompetencies[c].replace(/"/g,'&quot;') + '">' + c + '</div>';
  });
  html += '</div></div>';

  sidebar.innerHTML = html;

  // Accordion toggle
  sidebar.querySelectorAll('.fw-section-header').forEach(function(h) {
    h.addEventListener('click', function() { h.parentElement.classList.toggle('open'); });
  });
}


// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 8: SPATIAL PLANNER — DATA & CONSTANTS                  ║
// ╚══════════════════════════════════════════════════════════════════╝

const unit = 60;
let spatialInitialized = false;
let spatialChart = null;
let scenes = [];
let customPresets = [];
const selected = new Set();
let SNAP_RADIUS = unit * 0.35;
let NEIGHBOR_RADIUS = unit * 1.7;
let ANGLE_HYSTERESIS = 12;
const TRI_S = unit * 0.98;
const TRI_H = Math.sin(Math.PI/3) * TRI_S;
const PANEL_COUNT = 8;
const PANEL_THICKNESS = 10;
let panelState = { A: [], B: [] };

// DOM refs populated at init
let stage, itemsLayer, layoutRoot, operableWallsLayer, ghostLayer, marquee, toastEl;
let insightsContainer, wallAG, wallBG, toggleWall, toggleSnap, toggleLegend;
let sceneName, sceneList, llmPromptEl, llmGenerateBtn;
let savePresetModal, customPresetNameInput, confirmSavePresetBtn, cancelSavePresetBtn;
let chartTooltip, rightPanel;

// --- DRAWING & SVG HELPERS ---
function deskRect(g,{w,h,base}){ const r=rect(-w/2,-h/2,w,h,base,g); r.setAttribute('filter','url(#elev)'); rect(-w/2,h/2-3,w,3,'rgba(0,0,0,0.12)',g); const gloss=rect(-w/2,-h/2,w,h,'url(#deskGrad)',g,0.5); gloss.setAttribute('pointer-events','none'); line(-w/2+2,-h/2+2,w/2-2,-h/2+2,'#111827',3,g); }
function roundTable(g,{r,base}){ const c=circle(0,0,r,base,g); c.setAttribute('filter','url(#elev)'); svgStroke(c,'#111827',1); }
function trapDesk(g,{w,h,base}){ const path=document.createElementNS('http://www.w3.org/2000/svg','path'); const inset=w*0.2; path.setAttribute('d','M'+(-w/2)+','+(-h/2)+' L'+(w/2)+','+(-h/2)+' L'+(w/2-inset)+','+(h/2)+' L'+(-w/2+inset)+','+(h/2)+' Z'); path.setAttribute('fill',base); path.setAttribute('stroke','#111827'); path.setAttribute('stroke-width','1'); path.setAttribute('filter','url(#elev)'); g.appendChild(path); line(-w/2+2,-h/2+2,w/2-2,-h/2+2,'#111827',3,g); }
function triDesk(g,{s,base}){ const h=TRI_H; const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d','M'+(-s/2)+','+(h/2)+' L0,'+(-h/2)+' L'+(s/2)+','+(h/2)+' Z'); p.setAttribute('fill',base); p.setAttribute('stroke','#111827'); p.setAttribute('stroke-width','1'); p.setAttribute('filter','url(#elev)'); g.appendChild(p); line(s*(-0.4),h/2-0.1,s*0.4,h/2-0.1,'#111827',3,g); }
function chair(g,{w,h}){ const c=rect(-w/2,-h/2,w,h,'#e5e7eb',g); c.setAttribute('filter','url(#elev)'); line(-w/2+2,-h/2+2,w/2-2,-h/2+2,'#111827',2,g); }
function tv(g,{w,h}){ const b=rect(-w/2,-h/2,w,h,'#e5e7eb',g); b.setAttribute('filter','url(#elev)'); strokeRect(-w/2,-h/2,w,h,'#111827',2,g); rect(-w/2+4,-h/2+4,w-8,6,'rgba(0,0,0,0.15)',g); }
function vr(g,{r}){ const c=circle(0,0,r,'#dbeafe',g); c.setAttribute('filter','url(#elev)'); svgText(0,4,'VR',g); }
function cart(g,{w,h}){ const b=rect(-w/2,-h/2,w,h,'#e0e7ff',g); b.setAttribute('filter','url(#elev)'); rect(-w/2,h/2-3,w,3,'rgba(0,0,0,0.15)',g); }
function board(g,{w,h,base}){ const b=rect(-w/2,-h/2,w,h,base,g,0.22); b.setAttribute('filter','url(#elev)'); strokeRect(-w/2,-h/2,w,h,'#111827',1,g); }
function partition(g,{w,h,base}){ rect(-w/2,-h/2,w,h,base,g,0.7).setAttribute('filter','url(#elev)'); }
function couch(g,{w,h,base}){ const b=rect(-w/2,-h/2,w,h,base,g); b.setAttribute('filter','url(#elev)'); strokeRect(-w/2,-h/2,w,h,'#111827',1,g); rect(-w/2,h/2-3,w,3,'rgba(0,0,0,0.15)',g); }
function beanbag(g,{r,base}){ const c=circle(0,0,r,base,g); c.setAttribute('filter','url(#elev)'); }
function plant(g,{r}){ const c=circle(0,0,r,'#bbf7d0',g); c.setAttribute('filter','url(#elev)'); svgText(0,4,'\uD83C\uDF3F',g,16); }
function toolCabinet(g,{w,h}){ const b=rect(-w/2,-h/2,w,h,'#e5e7eb',g); b.setAttribute('filter','url(#elev)'); line(-w/2+4,-h/2+4,w/2-4,-h/2+4,'#9ca3af',2,g); line(-w/2+4,4,w/2-4,4,'#9ca3af',2,g); }
function printer3d(g,{w,h}){ const b=rect(-w/2,-h/2,w,h,'#d1d5db',g); b.setAttribute('filter','url(#elev)'); svgText(0,4,'3D',g); }
function zone(g,{w,h,base,label}){ label=label||'Zone'; const z=rect(-w/2,-h/2,w,h,base,g,0.16); z.setAttribute('data-zone','1'); svgStroke(z,'#374151',1); const t=svgText(0,4,label,g,12); t.setAttribute('data-zone-label','1'); }
function textLabel(g,{w,h,text:txt}){ const bg=rect(-w/2,-h/2,w,h,'transparent',g); bg.classList.add('text-label-bg'); const t=svgText(0,4,txt,g,14); t.classList.add('text-label-text'); }
function rect(x,y,w,h,fill,parent,alpha){ alpha=alpha===undefined?1:alpha; const el=document.createElementNS('http://www.w3.org/2000/svg','rect'); el.setAttribute('x',x); el.setAttribute('y',y); el.setAttribute('width',w); el.setAttribute('height',h); el.setAttribute('fill',fill); if(alpha!==1) el.setAttribute('fill-opacity',alpha); el.setAttribute('stroke','#111827'); el.setAttribute('stroke-width','1'); parent.appendChild(el); return el; }
function svgStroke(node,color,w){ node.setAttribute('stroke',color); node.setAttribute('stroke-width',w||1); return node; }
function strokeRect(x,y,w,h,color,sw,parent){ const el=document.createElementNS('http://www.w3.org/2000/svg','rect'); el.setAttribute('x',x); el.setAttribute('y',y); el.setAttribute('width',w); el.setAttribute('height',h); el.setAttribute('fill','none'); el.setAttribute('stroke',color); el.setAttribute('stroke-width',sw); parent.appendChild(el); return el; }
function circle(cx,cy,r,fill,parent){ const el=document.createElementNS('http://www.w3.org/2000/svg','circle'); el.setAttribute('cx',cx); el.setAttribute('cy',cy); el.setAttribute('r',r); el.setAttribute('fill',fill); el.setAttribute('stroke','#111827'); el.setAttribute('stroke-width',1); parent.appendChild(el); return el; }
function line(x1,y1,x2,y2,color,sw,parent){ const el=document.createElementNS('http://www.w3.org/2000/svg','line'); el.setAttribute('x1',x1); el.setAttribute('y1',y1); el.setAttribute('x2',x2); el.setAttribute('y2',y2); el.setAttribute('stroke',color); el.setAttribute('stroke-width',sw); parent.appendChild(el); return el; }
function svgText(x,y,str,parent,size){ size=size||12; const el=document.createElementNS('http://www.w3.org/2000/svg','text'); el.setAttribute('x',x); el.setAttribute('y',y); el.setAttribute('text-anchor','middle'); el.setAttribute('font-size',size); el.setAttribute('font-family','system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif'); el.textContent=str; parent.appendChild(el); return el; }

const PALETTE = [
  {cat:'furniture',id:'desk_rect',label:'Desk (rect)',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*1.0,h:unit*0.7,base:'#e5e7eb'})},snap:'edge90'},
  {cat:'furniture',id:'desk_round',label:'Table (round)',draw:function(g,o){roundTable(g,{x:0,y:0,r:unit*0.55,base:'#d1fae5'})},snap:'none'},
  {cat:'furniture',id:'desk_trap',label:'Desk (trapezoid)',draw:function(g,o){trapDesk(g,{x:0,y:0,w:unit*1.0,h:unit*0.7,base:'#fee2e2'})},snap:'edge60'},
  {cat:'furniture',id:'desk_tri_eq',label:'Desk (triangle)',draw:function(g,o){triDesk(g,{x:0,y:0,s:TRI_S,base:'#e0f2fe'})},snap:'tri60'},
  {cat:'furniture',id:'chair',label:'Chair',draw:function(g,o){chair(g,{x:0,y:0,w:unit*0.55,h:unit*0.55})},snap:'none'},
  {cat:'furniture',id:'stand_table',label:'Standing table (long)',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*2.4,h:unit*0.6,base:'#fde68a'})},snap:'edge90'},
  {cat:'tech',id:'writable_tv',label:'Writable TV',draw:function(g,o){tv(g,{x:0,y:0,w:unit*1.6,h:unit*0.9}); svgText(0,4,'wTV',g);},snap:'edge90'},
  {cat:'tech',id:'vr_station',label:'VR Station',draw:function(g,o){vr(g,{x:0,y:0,r:unit*0.5})},snap:'none'},
  {cat:'tech',id:'tablet_cart',label:'Tablet Cart',draw:function(g,o){cart(g,{x:0,y:0,w:unit*0.9,h:unit*0.7}); svgText(0,4,'iPads',g);},snap:'none'},
  {cat:'tech',id:'printer_3d',label:'3D Printer',draw:function(g,o){printer3d(g,{x:0,y:0,w:unit*0.8,h:unit*0.8})},snap:'none'},
  {cat:'cognitive',id:'whiteboard',label:'Mobile Whiteboard',draw:function(g,o){board(g,{x:0,y:0,w:unit*1.1,h:unit*1.6,base:'#93c5fd'}); svgText(0,4,'Board',g,14);},snap:'edge90'},
  {cat:'cognitive',id:'teacher_desk',label:'Teacher Desk',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*1.6,h:unit*0.8,base:'#bfdbfe'}); svgText(0,4,'TDesk',g);},snap:'edge90'},
  {cat:'cognitive',id:'tool_cabinet',label:'Tool Cabinet',draw:function(g,o){toolCabinet(g,{x:0,y:0,w:unit*1.5,h:unit*0.6})},snap:'edge90'},
  {cat:'social',id:'group_table',label:'Group Table (6)',draw:function(g,o){roundTable(g,{x:0,y:0,r:unit*0.8,base:'#a7f3d0'})},snap:'none'},
  {cat:'social',id:'partition',label:'Mobile Partition',draw:function(g,o){partition(g,{x:0,y:0,w:unit*0.3,h:unit*1.8,base:'#34d399'})},snap:'edge90'},
  {cat:'emotional',id:'couch',label:'Couch',draw:function(g,o){couch(g,{x:0,y:0,w:unit*1.8,h:unit*0.8,base:'#fdba74'})},snap:'edge90'},
  {cat:'emotional',id:'beanbag',label:'Beanbag',draw:function(g,o){beanbag(g,{x:0,y:0,r:unit*0.55,base:'#fde68a'})},snap:'none'},
  {cat:'emotional',id:'plant',label:'Plant',draw:function(g,o){plant(g,{x:0,y:0,r:unit*0.45})},snap:'none'},
  {cat:'stations',id:'desk_blue',label:'Desk (Blue)',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*1.0,h:unit*0.7,base:'#bfdbfe'})},snap:'edge90'},
  {cat:'stations',id:'desk_green',label:'Desk (Green)',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*1.0,h:unit*0.7,base:'#bbf7d0'})},snap:'edge90'},
  {cat:'stations',id:'desk_orange',label:'Desk (Orange)',draw:function(g,o){deskRect(g,{x:0,y:0,w:unit*1.0,h:unit*0.7,base:'#fed7aa'})},snap:'edge90'},
  {cat:'zones',id:'text_label',label:'Text Label',draw:function(g,o){textLabel(g,{x:0,y:0,w:unit*2,h:unit*0.8,text:'Double-click to edit'})},resizable:true},
  {cat:'zones',id:'zone_cog',label:'Zone: Cognitive',draw:function(g,o){zone(g,{x:0,y:0,w:unit*3,h:unit*2,base:'#93c5fd',label:'Cognitive'})},resizable:true},
  {cat:'zones',id:'zone_soc',label:'Zone: Social',draw:function(g,o){zone(g,{x:0,y:0,w:unit*3,h:unit*2,base:'#a7f3d0',label:'Social'})},resizable:true},
  {cat:'zones',id:'zone_emo',label:'Zone: Emotional',draw:function(g,o){zone(g,{x:0,y:0,w:unit*3,h:unit*2,base:'#fde68a',label:'Emotional'})},resizable:true}
];

const PRESET_INSIGHTS = {
  direct:[{title:'Clear Communication',affordance:'Rows facing a focal point ensures direct line of sight for instruction.',moves:['Use direct instruction for introducing new concepts.','Employ call-and-response techniques.']},{title:'Teacher Mobility',affordance:'Aisles allow the teacher to circulate, monitor progress, and provide support.',moves:['Walk the room during independent work.','Use proximity to manage off-task behavior.']},{title:'Focused Attention',affordance:'Structured layout minimizes peer distractions, encouraging individual focus.',moves:['Set clear time limits for tasks.','Use think-pair-share for brief peer interaction.']}],
  pods:[{title:'Enhanced Collaboration',affordance:'Clustered seating creates natural pods for group work and co-construction of knowledge.',moves:['Use jigsaw activities where each pod becomes expert on one topic.','Assign group roles for equitable participation.']},{title:'Peer-to-Peer Learning',affordance:'Proximity within pods encourages spontaneous discussion and problem-solving.',moves:['Provide complex problems requiring multiple perspectives.','Have groups present findings to the class.']},{title:'Shared Cognitive Load',affordance:'Students share resources and ideas, breaking down complex tasks.',moves:['Use large paper or mini-whiteboards for group brainstorming.','Facilitate group goal-setting.']}],
  stations:[{title:'Differentiated Instruction',affordance:'Multiple stations cater to different learning styles, paces, and readiness levels.',moves:['Design tasks at each station targeting specific skills.','Allow student self-selection based on learning goals.']},{title:'Active Learning',affordance:'Physical movement between stations keeps students engaged.',moves:['Use a timer to structure rotations.','Provide clear instructions at each station.']},{title:'Targeted Support',affordance:'Teacher can work intensively with a small group while others work independently.',moves:['Create a teacher-led station for re-teaching or enrichment.','Circulate among independent stations.']}],
  circle:[{title:'Democratic Dialogue',affordance:'Circle puts all participants on equal footing with clear sightlines to everyone.',moves:['Facilitate Socratic seminars or debates.','Establish norms for respectful listening.']},{title:'Full Class Visibility',affordance:'Every student is visible, encouraging active participation and accountability.',moves:['Use non-verbal cues to gauge understanding.','Pose open-ended questions inviting multiple viewpoints.']},{title:'Community Building',affordance:'No "front" of the room breaks down traditional hierarchies.',moves:['Start with a community-building check-in circle.','Use for storytelling or shared reading.']}],
  quiet:[{title:'Deep Focus',affordance:'Individual desks in uniform pattern minimize distractions.',moves:['Use for assessments, tests, or timed writing.','Play quiet background music.']},{title:'Self-Paced Learning',affordance:'Ideal for sustained independent concentration and self-pacing.',moves:['Provide playlists of online resources.','Offer extension activities for early finishers.']},{title:'Individual Accountability',affordance:'Separation makes it easy to monitor individual progress.',moves:['Circulate for one-on-one feedback.','Use mini-whiteboards for quick checks.']}],
  maker:[{title:'Hands-On Creation',affordance:'Large work surfaces and diverse tools empower hands-on design and prototyping.',moves:['Pose design challenges requiring physical solutions.','Set up tinkering stations.']},{title:'Flexible Movement',affordance:'Open plan allows easy movement between ideation and fabrication zones.',moves:['Encourage design thinking: empathize, define, ideate, prototype, test.','Use mobile whiteboards for design processes.']},{title:'Interdisciplinary Thinking',affordance:'Blends art, design, engineering, and technology.',moves:['Create cross-curricular projects.','Invite community experts to mentor.']}],
  fishbowl:[{title:'Focused Dialogue',affordance:'Inner circle creates a stage for speakers; outer circle for active listeners.',moves:['Use for structured debates or Socratic seminars.','Provide outer circle with observation tasks.']},{title:'Active Listening',affordance:'Distinct speaker/listener roles make active listening explicit.',moves:['Have outer circle provide feedback on discussion quality.','Rotate between inner and outer circles.']},{title:'Structured Participation',affordance:'Clear structure ensures focused, productive full-class discussion.',moves:['Use hot seat model for Q&A.','Establish norms for entering/exiting inner circle.']}],
  gallery:[{title:'Peer Feedback',affordance:'Work spread around the room enables structured peer-to-peer feedback.',moves:['Provide sticky notes or feedback forms.','Use "I like, I wonder, What if" protocol.']},{title:'Showcasing Process',affordance:'Perfect for displaying multiple project stages.',moves:['Display drafts and final versions side-by-side.','Have students present their exhibit to small groups.']},{title:'Synthesizing Information',affordance:'Each station presents different information requiring synthesis.',moves:['Use for analyzing different documents or data sets.','Provide graphic organizer to complete while visiting stations.']}]
};

const CHART_DEFINITIONS = {
  Sightlines:{definition:'How clearly students can see instructional focal points.',reading:'Higher = better visibility. Lower = potential obstructions.'},
  Mobility:{definition:'Ease of movement for teachers and students.',reading:'Higher = more open circulation. Lower = cramped layout.'},
  Flexibility:{definition:'Variety of furniture and ease of reconfiguring the space.',reading:'Higher = highly adaptable. Lower = static setup.'},
  Density:{definition:'Personal and group space available to each student.',reading:'Higher = more space per student. Lower = overcrowding.'},
  Modality:{definition:'Support for various learning modes (group, individual, presentation).',reading:'Higher = multi-functional. Lower = optimized for one activity.'},
  Environment:{definition:'Natural light and biophilic elements contributing to wellbeing.',reading:'Higher = comfortable atmosphere. Lower = less stimulating.'}
};


// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 9: SPATIAL PLANNER — INTERACTION & CORE LOGIC          ║
// ╚══════════════════════════════════════════════════════════════════╝

const snap = function(v){ return Math.round(v/unit)*unit; };
const deg = function(r){ return r*180/Math.PI; };
const rad = function(d){ return d*Math.PI/180; };
const normAngle = function(a){ return (a%360+360)%360; };
function getMouseSVG(evt){ var p=stage.createSVGPoint(); p.x=evt.clientX; p.y=evt.clientY; return p.matrixTransform(stage.getScreenCTM().inverse()); }
function getTranslate(g){ var tr=g.getAttribute('transform')||''; var m=/translate\(([-0-9.]+),\s*([-0-9.]+)\)/.exec(tr); return m?[parseFloat(m[1]),parseFloat(m[2])]:[0,0]; }
function getRotate(g){ var tr=g.getAttribute('transform')||''; var m=/rotate\(([-0-9.]+)\)/.exec(tr); return m?parseFloat(m[1]):0; }
function flash(msg){ toastEl.textContent=msg; toastEl.style.display='block'; clearTimeout(flash._t); flash._t=setTimeout(function(){toastEl.style.display='none';},1600); }

function drawSelection(){ itemsLayer.querySelectorAll('.selection').forEach(function(n){n.remove();}); operableWallsLayer.querySelectorAll('.selection').forEach(function(n){n.remove();}); selected.forEach(function(g){ var bb=g.getBBox(); var r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.classList.add('selection'); r.setAttribute('x',bb.x-6); r.setAttribute('y',bb.y-6); r.setAttribute('width',bb.width+12); r.setAttribute('height',bb.height+12); r.setAttribute('rx',6); r.setAttribute('ry',6); r.setAttribute('fill','none'); r.setAttribute('stroke','var(--accent)'); r.setAttribute('stroke-width','2'); r.setAttribute('vector-effect','non-scaling-stroke'); r.setAttribute('pointer-events','none'); g.insertBefore(r,g.firstChild); }); }
function clearSelection(){ selected.clear(); itemsLayer.querySelectorAll('.selection').forEach(function(n){n.remove();}); operableWallsLayer.querySelectorAll('.selection').forEach(function(n){n.remove();}); removeHandles(); }

function addItem(def){
  var wrapper=document.createElementNS('http://www.w3.org/2000/svg','g');
  wrapper.setAttribute('data-id',def.id); wrapper.setAttribute('data-snap',def.snap||'none');
  if(def.resizable) wrapper.setAttribute('data-resizable','1');
  wrapper.setAttribute('transform','translate('+unit*2+','+unit*2+') rotate(0)'); wrapper.style.cursor='move';
  var g=document.createElementNS('http://www.w3.org/2000/svg','g'); def.draw(g,{x:0,y:0}); wrapper.appendChild(g);
  layoutRoot.appendChild(wrapper); makeDraggable(wrapper);
  if(def.id==='text_label') wrapper.addEventListener('dblclick',editTextLabel);
  clearSelection(); selected.add(wrapper); drawSelection(); flash('Tip: Hold Alt to bypass snapping'); updateMetrics();
}

function makeDraggable(g){
  var offset={x:0,y:0},dragging=false,groupStart=null;
  g.addEventListener('pointerdown',function(e){
    e.stopPropagation(); dragging=true; g.setPointerCapture(e.pointerId);
    if(!e.shiftKey&&!selected.has(g)){clearSelection();selected.add(g);drawSelection();}
    var pt=getMouseSVG(e); groupStart=[].map.call(selected,function(node){return{node:node,t:getTranslate(node)};});
    // Fix: convert selected Set to array properly
    groupStart=[];selected.forEach(function(node){groupStart.push({node:node,t:getTranslate(node)});});
    var meStart; groupStart.forEach(function(s){if(s.node===g)meStart=s.t;});
    offset={x:pt.x-meStart[0],y:pt.y-meStart[1]};
  });
  g.addEventListener('pointermove',function(e){
    if(!dragging) return;
    var pt=getMouseSVG(e); var bypass=e.altKey||!toggleSnap.checked;
    var nx=pt.x-offset.x,ny=pt.y-offset.y;
    if(!bypass){nx=snap(nx);ny=snap(ny);}
    var meStart; groupStart.forEach(function(s){if(s.node===g)meStart=s.t;});
    var dx=nx-meStart[0],dy=ny-meStart[1];
    groupStart.forEach(function(s){
      var px=s.t[0]+dx,py=s.t[1]+dy;
      px=Math.max(0,Math.min(px,1440-unit)); py=Math.max(0,Math.min(py,720-unit));
      var r=getRotate(s.node); s.node.setAttribute('transform','translate('+px+','+py+') rotate('+r+')');
    });
    if(selected.size===1){if(!bypass)trySnap(g,true);else clearGhost();}else{clearGhost();}
    drawSelection();
  });
  g.addEventListener('pointerup',function(e){
    dragging=false; try{g.releasePointerCapture(e.pointerId);}catch(_){}
    if(selected.size===1){var bypass=e.altKey||!toggleSnap.checked;if(!bypass)trySnap(g,false);}
    clearGhost(); updateMetrics();
  });
}

function centroidOfSelection(){ var arr=[]; selected.forEach(function(n){arr.push(n);}); if(!arr.length) return null; var pts=arr.map(getTranslate); var cx=pts.reduce(function(a,p){return a+p[0];},0)/pts.length; var cy=pts.reduce(function(a,p){return a+p[1];},0)/pts.length; return{cx:cx,cy:cy}; }

function rotateSelection(useFine,isAltPressed){
  if(!selected.size) return;
  var step=isAltPressed?1:(useFine?15:45);
  if(selected.size===1){
    var node; selected.forEach(function(n){node=n;});
    var t=getTranslate(node); var currentRot=getRotate(node); var nextRot=currentRot+step;
    if(!isAltPressed&&toggleSnap.checked){
      var mode=node.getAttribute('data-snap');
      if(mode==='tri60'||mode==='edge60'){nextRot=Math.round(nextRot/60)*60;}
      else if(mode==='edge90'){var n=Math.round(nextRot/90)*90;if(Math.abs(n-nextRot)<=ANGLE_HYSTERESIS)nextRot=n;}
    }
    node.setAttribute('transform','translate('+t[0]+','+t[1]+') rotate('+normAngle(nextRot)+')');
    drawSelection(); updateMetrics(); return;
  }
  var C=centroidOfSelection(); if(!C) return;
  var theta=rad(step),sinT=Math.sin(theta),cosT=Math.cos(theta);
  selected.forEach(function(node){
    var t=getTranslate(node); var vx=t[0]-C.cx,vy=t[1]-C.cy;
    var rx=vx*cosT-vy*sinT,ry=vx*sinT+vy*cosT;
    var newRot=getRotate(node)+step;
    node.setAttribute('transform','translate('+(C.cx+rx)+','+(C.cy+ry)+') rotate('+normAngle(newRot)+')');
  });
  drawSelection(); updateMetrics();
}
rotateSelection._lastAlt = false;

// --- OPERABLE WALLS ---
function buildOperableWalls(){
  wallAG.innerHTML=''; wallBG.innerHTML=''; panelState={A:[],B:[]};
  [{g:wallAG,x:720,id:'A'},{g:wallBG,x:1080,id:'B'}].forEach(function(cfg){
    for(var i=0;i<PANEL_COUNT;i++){
      var panel=document.createElementNS('http://www.w3.org/2000/svg','g');
      panel.classList.add('ow-panel'); panel.setAttribute('data-id','ow-panel-'+cfg.id+'-'+i); panel.setAttribute('data-track',cfg.x);
      var r=document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('rx',2);r.setAttribute('fill','#dbeafe');r.setAttribute('stroke','var(--ink)');r.setAttribute('stroke-width','1');r.setAttribute('filter','url(#elev)');
      panel.appendChild(r); cfg.g.appendChild(panel); panelState[cfg.id].push({node:panel}); makeWallPanelDraggable(panel);
    }
  });
}
function closeWall(which){
  var arr=panelState[which]; var x=(which==='A')?720:1080;
  var segH=(720-(PANEL_COUNT-1)*2)/PANEL_COUNT;
  arr.forEach(function(st,i){
    var y=(segH/2)+(i*(segH+2)); st.node.setAttribute('transform','translate('+x+','+y+') rotate(0)');
    var r=st.node.querySelector('rect'); r.setAttribute('width',PANEL_THICKNESS); r.setAttribute('height',segH); r.setAttribute('x',-PANEL_THICKNESS/2); r.setAttribute('y',-segH/2);
  });
  flash('Wall '+which+' Closed'); updateMetrics();
}
function stackWall(which,topCount){
  topCount=topCount||4;
  var arr=panelState[which]; var x=(which==='A')?720:1080;
  var segH=(720-(PANEL_COUNT-1)*2)/PANEL_COUNT; var topX=x-segH; var botX=x;
  arr.forEach(function(st,i){
    var r=st.node.querySelector('rect'); r.setAttribute('width',segH); r.setAttribute('height',PANEL_THICKNESS); r.setAttribute('x',0); r.setAttribute('y',0);
    if(i<topCount){ var y=10+(i*(PANEL_THICKNESS+2)); st.node.setAttribute('transform','translate('+topX+','+y+') rotate(0)'); }
    else{ var y=720-10-((PANEL_COUNT-i)*(PANEL_THICKNESS+2)); st.node.setAttribute('transform','translate('+botX+','+y+') rotate(0)'); }
  });
  flash('Wall '+which+' Stacked'); updateMetrics();
}
function makeWallPanelDraggable(g){
  var offset={y:0},dragging=false,startPos=null;
  g.addEventListener('pointerdown',function(e){
    e.stopPropagation(); dragging=true; g.setPointerCapture(e.pointerId);
    if(!e.shiftKey&&!selected.has(g)){clearSelection();selected.add(g);drawSelection();}
    var pt=getMouseSVG(e); startPos=getTranslate(g); offset={y:pt.y-startPos[1]};
  });
  g.addEventListener('pointermove',function(e){
    if(!dragging) return; var pt=getMouseSVG(e); var ny=pt.y-offset.y;
    var r=g.querySelector('rect'); var h=+r.getAttribute('height'); ny=Math.max(h/2,Math.min(ny,720-h/2));
    g.setAttribute('transform','translate('+startPos[0]+','+ny+') rotate('+getRotate(g)+')'); drawSelection();
  });
  g.addEventListener('pointerup',function(e){ dragging=false; try{g.releasePointerCapture(e.pointerId);}catch(_){} updateMetrics(); });
}

// --- METRICS ---
function updateMetrics(){
  if(!spatialInitialized) return;
  var furnitureItems=Array.from(layoutRoot.querySelectorAll('g[data-id]'));
  var isWallAOpen=panelState.A.some(function(p){return getTranslate(p.node)[0]!==720;});
  var isWallBOpen=panelState.B.some(function(p){return getTranslate(p.node)[0]!==1080;});
  var totalWidth=720; if(isWallAOpen) totalWidth+=360; if(isWallBOpen) totalWidth+=360;
  var roomArea=totalWidth*720;
  var desks=furnitureItems.filter(function(n){return /desk_/.test(n.getAttribute('data-id'))||n.getAttribute('data-id')==='chair';});
  var itemIds=new Set(furnitureItems.map(function(n){return n.getAttribute('data-id');}));
  var pos=function(g){return getTranslate(g);};
  var count=function(id){return furnitureItems.filter(function(i){return i.getAttribute('data-id')===id;}).length;};

  var sightlineScore=20;
  var teachingPoints=furnitureItems.filter(function(i){return['teacher_desk','writable_tv','whiteboard'].indexOf(i.getAttribute('data-id'))>=0;}).map(function(tp){var t=pos(tp);return{x:t[0],y:t[1]};});
  if(!teachingPoints.length) teachingPoints.push({x:720,y:10});
  if(desks.length>0){
    var good=0;
    desks.forEach(function(desk){
      var d=pos(desk); var dAngle=rad(getRotate(desk)+90);
      var fv={x:Math.cos(dAngle),y:Math.sin(dAngle)};
      var best=teachingPoints.reduce(function(b,tp){return Math.hypot(tp.x-d[0],tp.y-d[1])<Math.hypot(b.x-d[0],b.y-d[1])?tp:b;},teachingPoints[0]);
      var toTp={x:best.x-d[0],y:best.y-d[1]}; var mag=Math.hypot(toTp.x,toTp.y); if(!mag) return;
      var dot=fv.x*toTp.x+fv.y*toTp.y; var angleDiff=Math.acos(dot/mag);
      if(deg(angleDiff)<45) good++;
    });
    sightlineScore=20+Math.round((good/desks.length)*80);
  }
  var occupiedArea=furnitureItems.reduce(function(acc,n){var b=n.getBBox();return acc+(b.width*b.height);},0);
  var mobilityScore=Math.max(0,Math.min(100,(1-(occupiedArea/roomArea))*150-10));
  var studentCapacity=desks.length; var densityScore=50;
  if(studentCapacity>0){var aps=roomArea/studentCapacity;var minA=12000;var maxA=45000;var ca=Math.max(minA,Math.min(aps,maxA));densityScore=10+((ca-minA)/(maxA-minA))*90;}
  var fTypes=new Set(PALETTE.filter(function(p){return itemIds.has(p.id)&&p.cat==='furniture';}).map(function(p){return p.id;}));
  var mobileItems=['whiteboard','partition','chair','beanbag','tablet_cart'];
  var mobileCount=mobileItems.reduce(function(s,id){return s+count(id);},0);
  var flexScore=20+(fTypes.size*5)+(furnitureItems.length>0?(mobileCount/furnitureItems.length)*50:0);
  if(furnitureItems.some(function(i){return i.getAttribute('data-id').indexOf('zone_')===0;})) flexScore+=10;
  flexScore=Math.min(100,flexScore);
  var inCluster=0; desks.forEach(function(d,i){for(var j=i+1;j<desks.length;j++){if(Math.hypot(pos(d)[0]-pos(desks[j])[0],pos(d)[1]-pos(desks[j])[1])<=unit*1.5){inCluster++;break;}}});
  var clusterRatio=desks.length>0?inCluster/desks.length:0;
  var modalityScore=10; if(clusterRatio>0.5)modalityScore+=30; if(itemIds.has('writable_tv')||itemIds.has('whiteboard'))modalityScore+=25;
  if(itemIds.has('group_table'))modalityScore+=15; if(itemIds.has('stand_table'))modalityScore+=15;
  if(itemIds.has('couch')||itemIds.has('beanbag'))modalityScore+=10; modalityScore=Math.min(100,modalityScore);
  var plantCount=count('plant'); var lightScore=0;
  if(desks.length>0){var dNear=desks.filter(function(d){return pos(d)[1]<unit*2||pos(d)[1]>720-(unit*2);}).length;lightScore=(dNear/desks.length)*50;}
  var envScore=20+Math.min(80,(plantCount*15)+lightScore);
  if(spatialChart){spatialChart.data.datasets[0].data=[sightlineScore,mobilityScore,flexScore,densityScore,modalityScore,envScore].map(Math.round);spatialChart.update();}
}

function renderInsights(insights){
  insightsContainer.innerHTML='';
  insights.forEach(function(insight){
    var group=document.createElement('div'); group.className='insight-group';
    var movesHTML=insight.moves.map(function(m){return '<li>'+m+'</li>';}).join('');
    group.innerHTML='<h3 class="insight-title">'+insight.title+'</h3><p class="insight-subtitle">Affordances of this Layout</p><p class="insight-text">'+insight.affordance+'</p><p class="insight-subtitle">Suggested Pedagogical Moves (STP)</p><ul class="insight-list">'+movesHTML+'</ul>';
    insightsContainer.appendChild(group);
  });
}

// --- CHART ---
function initializeChart(){
  var canvas=document.getElementById('spatialEffectivenessChart');
  var isDark=document.documentElement.classList.contains('dark');
  var gridColor=isDark?'rgba(107,114,128,0.5)':'rgba(209,213,219,1)';
  var pointLabelColor=isDark?'#9ca3af':'#4b5563';
  var datasetBG=isDark?'rgba(255,226,0,0.3)':'rgba(0,12,83,0.2)';
  var datasetBorder=isDark?'#FFE200':'#000C53';
  var externalTooltipHandler=function(context){
    var tooltip=context.tooltip; var tooltipEl=chartTooltip;
    if(tooltip.opacity===0){tooltipEl.style.display='none';return;}
    var point=tooltip.dataPoints[0]; if(!point) return;
    var labelName=point.label; var score=point.raw; var def=CHART_DEFINITIONS[labelName];
    if(def){
      tooltipEl.innerHTML='<h4>'+labelName+' (Score: '+score+')</h4><p>'+def.definition+'</p><p class="reading">\u25B6 '+def.reading+'</p>';
      var panelRect=rightPanel.getBoundingClientRect(); var chartRect=context.chart.canvas.getBoundingClientRect();
      var left=chartRect.left-panelRect.left+tooltip.caretX; var top=chartRect.top-panelRect.top+tooltip.caretY;
      if(left+tooltipEl.offsetWidth+15>panelRect.width) left-=(tooltipEl.offsetWidth+30); else left+=15;
      if(top+tooltipEl.offsetHeight>panelRect.height) top-=tooltipEl.offsetHeight;
      tooltipEl.style.left=left+'px'; tooltipEl.style.top=top+'px'; tooltipEl.style.display='block';
    }
  };
  spatialChart=new Chart(canvas,{
    type:'radar',
    data:{labels:['Sightlines','Mobility','Flexibility','Density','Modality','Environment'],datasets:[{label:'Effectiveness',data:[50,50,50,50,50,50],fill:true,backgroundColor:datasetBG,borderColor:datasetBorder,pointBackgroundColor:datasetBorder,pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:datasetBorder}]},
    options:{elements:{line:{borderWidth:2}},scales:{r:{angleLines:{color:gridColor},grid:{color:gridColor},suggestedMin:0,suggestedMax:100,ticks:{display:false,stepSize:25},pointLabels:{font:{size:11},color:pointLabelColor}}},plugins:{legend:{display:false},tooltip:{enabled:false,position:'nearest',external:externalTooltipHandler}}}
  });
}

// --- PRESETS ---
function applyPreset(name,studentCount){
  studentCount=studentCount||28;
  layoutRoot.innerHTML=''; clearSelection(); removeHandles(); clearGhost();
  var cp=customPresets.find(function(p){return p.name===name;});
  if(cp){
    layoutRoot.innerHTML=cp.layoutHTML;
    Array.from(layoutRoot.querySelectorAll('g[data-id]')).forEach(function(g){makeDraggable(g);if(g.getAttribute('data-id')==='text_label')g.addEventListener('dblclick',editTextLabel);});
    if(cp.wallAState==='stacked')stackWall('A');else closeWall('A');
    if(cp.wallBState==='stacked')stackWall('B');else closeWall('B');
    flash('Loaded custom preset: '+name); updateMetrics(); insightsContainer.innerHTML=''; return;
  }
  if(name==='direct'||name==='quiet'){closeWall('A');closeWall('B');}else{stackWall('A');stackWall('B');}
  var make=function(id){var def=PALETTE.find(function(p){return p.id===id;});if(!def)return null;var wrapper=document.createElementNS('http://www.w3.org/2000/svg','g');wrapper.setAttribute('data-id',def.id);wrapper.setAttribute('data-snap',def.snap||'none');if(def.resizable)wrapper.setAttribute('data-resizable','1');wrapper.style.cursor='move';var g=document.createElementNS('http://www.w3.org/2000/svg','g');def.draw(g,{x:0,y:0});wrapper.appendChild(g);layoutRoot.appendChild(wrapper);makeDraggable(wrapper);return wrapper;};
  var place=function(w,x,y,r){r=r||0;if(w)w.setAttribute('transform','translate('+x+','+y+') rotate('+r+')');};

  if(name==='direct'){var td=make('teacher_desk');place(td,unit*1.2,unit*3,90);var t=make('writable_tv');place(t,unit*2.8,unit*2.8,90);var cols=5;var rows=Math.ceil(studentCount/cols);var aisleCol=3;for(var r=0;r<rows;r++){for(var c=0;c<cols;c++){if(r*cols+c>=studentCount)break;var d=make('desk_rect');var cx=c+(c>=aisleCol?0.4:0);place(d,unit*(6+cx*1.3),unit*(2+r*1.2),90);}}}
  if(name==='pods'){var pods=Math.ceil(studentCount/6);var centers=[[unit*5,unit*3],[unit*9,unit*3],[unit*13,unit*3],[unit*5,unit*7.5],[unit*9,unit*7.5],[unit*13,unit*7.5]];for(var i=0;i<pods&&i<centers.length;i++){var cc=centers[i];var radius=TRI_H*0.6;for(var j=0;j<6;j++){var angle=j*60;var x=cc[0]+radius*Math.cos(rad(angle));var y=cc[1]+radius*Math.sin(rad(angle));place(make('desk_tri_eq'),x,y,angle-90);}}place(make('whiteboard'),unit*1.2,unit*1.2,90);}
  if(name==='stations'){place(make('teacher_desk'),unit*11.5,unit*10,180);place(make('desk_trap'),unit*10,unit*8,0);place(make('desk_trap'),unit*11.5,unit*8,0);place(make('desk_trap'),unit*13,unit*8,0);place(make('writable_tv'),unit*3,unit*1.5,0);place(make('group_table'),unit*3,unit*4);place(make('chair'),unit*2,unit*3.5);place(make('chair'),unit*4,unit*3.5);place(make('chair'),unit*3,unit*5);place(make('couch'),unit*21,unit*2,0);place(make('beanbag'),unit*22.5,unit*3.5);place(make('beanbag'),unit*19.5,unit*3.5);place(make('plant'),unit*21,unit*4);place(make('stand_table'),unit*20,unit*9,90);place(make('printer_3d'),unit*22,unit*8);place(make('tool_cabinet'),unit*22,unit*10,180);}
  if(name==='circle'){var cx=unit*12,cy=unit*6;var radius=Math.min(unit*5,(studentCount/18)*unit*5);for(var i=0;i<studentCount;i++){var angle=(i/studentCount)*2*Math.PI;place(make('desk_rect'),cx+Math.cos(angle)*radius,cy+Math.sin(angle)*radius,deg(angle)+90);}place(make('whiteboard'),unit*1.2,unit*2,90);}
  if(name==='quiet'){var td=make('teacher_desk');place(td,unit*1.2,unit*3,90);var cols=5;var rows=Math.ceil(studentCount/cols);for(var r=0;r<rows;r++){for(var c=0;c<cols;c++){if(r*cols+c>=studentCount)break;place(make('desk_rect'),unit*(4+c*1.4),unit*(1.8+r*1.2),90);}}}
  if(name==='maker'){place(make('whiteboard'),unit*1.5,unit*2,90);place(make('group_table'),unit*4,unit*3);place(make('stand_table'),unit*10,unit*3.5,0);place(make('stand_table'),unit*10,unit*6.5,0);place(make('printer_3d'),unit*13.5,unit*2.5);place(make('tool_cabinet'),unit*13.5,unit*8.5,180);place(make('writable_tv'),unit*22,unit*5,-90);place(make('desk_rect'),unit*19,unit*2);place(make('desk_rect'),unit*19,unit*4);place(make('desk_rect'),unit*19,unit*6);place(make('tablet_cart'),unit*1.5,unit*9);}
  if(name==='fishbowl'){var inner=Math.min(8,Math.floor(studentCount/3));var outer=studentCount-inner;var cx=unit*12,cy=unit*6;var iR=unit*2.5,oR=unit*4.5;for(var i=0;i<inner;i++){var a=(i/inner)*2*Math.PI;place(make('desk_rect'),cx+Math.cos(a)*iR,cy+Math.sin(a)*iR,deg(a)+90);}for(var i=0;i<outer;i++){var a=(i/outer)*2*Math.PI;place(make('desk_rect'),cx+Math.cos(a)*oR,cy+Math.sin(a)*oR,deg(a)+90);}}
  if(name==='gallery'){var stations=Math.min(studentCount,10);var wOff=unit*1.5;for(var i=0;i<stations;i++){var wb=make('whiteboard');if(i<5)place(wb,wOff+i*unit*2.5,wOff,0);else place(wb,wOff+(i-5)*unit*2.5,720-wOff,180);}}
  updateMetrics(); renderInsights(PRESET_INSIGHTS[name]||[]);
}

// --- SCENES ---
function saveScene(){ var name=sceneName.value.trim()||('Scene '+(scenes.length+1)); var svgData=new XMLSerializer().serializeToString(layoutRoot); scenes.push({name:name,svgData:svgData}); renderScenes(); sceneName.value=''; flash('Scene saved'); }
function renderScenes(){
  sceneList.innerHTML='';
  scenes.forEach(function(s,idx){
    var row=document.createElement('div');row.className='scene-item';
    var input=document.createElement('input');input.value=s.name;input.addEventListener('change',function(){s.name=input.value;});
    var actions=document.createElement('div');actions.className='scene-actions';
    var apply=document.createElement('button');apply.className='ghost';apply.textContent='Apply';
    apply.addEventListener('click',function(){layoutRoot.innerHTML=new DOMParser().parseFromString(s.svgData,'image/svg+xml').documentElement.innerHTML;Array.from(layoutRoot.querySelectorAll('g[data-id]')).forEach(makeDraggable);clearSelection();updateMetrics();});
    var del=document.createElement('button');del.className='danger';del.textContent='Delete';
    del.addEventListener('click',function(){scenes.splice(idx,1);renderScenes();});
    actions.appendChild(apply);actions.appendChild(del);row.appendChild(input);row.appendChild(actions);sceneList.appendChild(row);
  });
}

// --- CUSTOM PRESETS ---
function showSavePresetModal(){customPresetNameInput.value='My Layout '+(customPresets.length+1);savePresetModal.style.display='flex';customPresetNameInput.focus();customPresetNameInput.select();}
function hideSavePresetModal(){savePresetModal.style.display='none';}
function handleConfirmSavePreset(){
  var name=customPresetNameInput.value.trim();if(!name){flash('Please enter a preset name.');return;}
  var layoutHTML=layoutRoot.innerHTML;
  var wallAState=panelState.A.some(function(p){return getTranslate(p.node)[0]!==720;})?'stacked':'closed';
  var wallBState=panelState.B.some(function(p){return getTranslate(p.node)[0]!==1080;})?'stacked':'closed';
  customPresets.push({name:name,layoutHTML:layoutHTML,wallAState:wallAState,wallBState:wallBState});
  localStorage.setItem('spatialPlannerCustomPresets',JSON.stringify(customPresets));
  populateCustomPresets(); hideSavePresetModal(); flash('Saved preset: '+name);
}
function loadCustomPresets(){var s=localStorage.getItem('spatialPlannerCustomPresets');if(s){customPresets=JSON.parse(s);populateCustomPresets();}}
function populateCustomPresets(){var group=document.getElementById('customPresetGroup');group.innerHTML='';customPresets.forEach(function(p){var o=document.createElement('option');o.value=p.name;o.textContent=p.name;group.appendChild(o);});}

// --- SNAP ---
function trySnap(g,preview){
  clearGhost(); var mode=g.getAttribute('data-snap')||'none'; if(mode==='none') return;
  var t=getTranslate(g); var tx=t[0],ty=t[1]; var rot=normAngle(getRotate(g));
  var step=(mode==='tri60'||mode==='edge60')?60:90;
  var snappedRot=Math.round(rot/step)*step;
  if(!rotateSelection._lastAlt&&Math.abs(snappedRot-rot)<=ANGLE_HYSTERESIS) rot=snappedRot;
  var neighbors=Array.from(layoutRoot.querySelectorAll('g[data-snap]')).filter(function(n){return n!==g;});
  var applied=false;
  for(var ni=0;ni<neighbors.length;ni++){
    var n=neighbors[ni]; var nt=getTranslate(n); var dist=Math.hypot(nt[0]-tx,nt[1]-ty);
    if(dist>NEIGHBOR_RADIUS) continue;
    if(mode==='tri60'&&n.getAttribute('data-snap')==='tri60'){
      var s=TRI_S,h=TRI_H;
      var offsets=[{dx:s,dy:0,a:0},{dx:s/2,dy:h,a:60},{dx:-s/2,dy:h,a:120},{dx:-s,dy:0,a:180},{dx:-s/2,dy:-h,a:240},{dx:s/2,dy:-h,a:300}];
      for(var oi=0;oi<offsets.length;oi++){
        var off=offsets[oi]; var tx2=nt[0]+off.dx,ty2=nt[1]+off.dy;
        if(Math.hypot(tx2-tx,ty2-ty)<=SNAP_RADIUS){
          if(preview){drawGhostTri(tx2,ty2,off.a,s);}else{g.setAttribute('transform','translate('+snap(tx2)+','+snap(ty2)+') rotate('+off.a+')');}
          applied=true;break;
        }
      }
    }
    if(applied) break;
    var dx=Math.abs(nt[0]-tx),dy=Math.abs(nt[1]-ty);
    if(dx<=SNAP_RADIUS||dy<=SNAP_RADIUS){
      var nx2=dx<=SNAP_RADIUS?nt[0]:tx; var ny2=dy<=SNAP_RADIUS?nt[1]:ty;
      if(preview){drawGhostBox(nx2,ny2,g);}else{g.setAttribute('transform','translate('+snap(nx2)+','+snap(ny2)+') rotate('+rot+')');}
      applied=true;break;
    }
  }
}
function clearGhost(){ghostLayer.innerHTML='';}
function drawGhostBox(x,y,g){var bb=g.getBBox();var r=document.createElementNS('http://www.w3.org/2000/svg','rect');r.setAttribute('x',x+bb.x);r.setAttribute('y',y+bb.y);r.setAttribute('width',bb.width);r.setAttribute('height',bb.height);r.setAttribute('class','ghost-snap');ghostLayer.appendChild(r);}
function drawGhostTri(cx,cy,angle,s){var h=Math.sin(Math.PI/3)*s;var pts=[[-s/2,h/2],[0,-h/2],[s/2,h/2]].map(function(p){var rx=Math.cos(rad(angle))*p[0]-Math.sin(rad(angle))*p[1]+cx;var ry=Math.sin(rad(angle))*p[0]+Math.cos(rad(angle))*p[1]+cy;return[rx,ry];});var path=document.createElementNS('http://www.w3.org/2000/svg','path');path.setAttribute('d','M'+pts[0][0]+','+pts[0][1]+' L'+pts[1][0]+','+pts[1][1]+' L'+pts[2][0]+','+pts[2][1]+' Z');path.setAttribute('class','ghost-snap');ghostLayer.appendChild(path);}

// --- RESIZE ---
var activeHandle=null;
function showHandles(g){
  g.querySelectorAll('.handle').forEach(function(n){n.remove();});
  var bb=g.querySelector('g').getBBox();
  var corners=[{name:'nw',x:bb.x,y:bb.y},{name:'ne',x:bb.x+bb.width,y:bb.y},{name:'se',x:bb.x+bb.width,y:bb.y+bb.height},{name:'sw',x:bb.x,y:bb.y+bb.height}];
  corners.forEach(function(c){
    var h=document.createElementNS('http://www.w3.org/2000/svg','rect');h.classList.add('handle');h.setAttribute('data-handle',c.name);
    h.setAttribute('x',c.x-6);h.setAttribute('y',c.y-6);h.setAttribute('width',12);h.setAttribute('height',12);
    h.setAttribute('fill','var(--accent)');h.setAttribute('opacity','0.85');h.style.cursor=c.name+'-resize';
    h.addEventListener('pointerdown',function(e){startResize(e,g,h);});g.appendChild(h);
  });
}
function removeHandles(){layoutRoot.querySelectorAll('.handle').forEach(function(n){n.remove();});}
function startResize(e,g,handle){
  e.stopPropagation(); activeHandle=handle.getAttribute('data-handle'); handle.setPointerCapture(e.pointerId);
  var start=getMouseSVG(e); var nodeToResize=g.querySelector('rect[data-zone], rect.text-label-bg'); if(!nodeToResize) return;
  var startBox={x:+nodeToResize.getAttribute('x'),y:+nodeToResize.getAttribute('y'),w:+nodeToResize.getAttribute('width'),h:+nodeToResize.getAttribute('height')};
  var rotation=getRotate(g); var angleRad=-rad(rotation); var cosA=Math.cos(angleRad); var sinA=Math.sin(angleRad); var min=unit;
  var onMove=function(ev){
    var cur=getMouseSVG(ev);var dx=cur.x-start.x;var dy=cur.y-start.y;
    var lDx=dx*cosA-dy*sinA;var lDy=dx*sinA+dy*cosA;
    var x=startBox.x,y=startBox.y,w=startBox.w,h=startBox.h;
    if(activeHandle.indexOf('n')>=0){y=startBox.y+lDy;h=startBox.h-lDy;}
    if(activeHandle.indexOf('s')>=0){h=startBox.h+lDy;}
    if(activeHandle.indexOf('w')>=0){x=startBox.x+lDx;w=startBox.w-lDx;}
    if(activeHandle.indexOf('e')>=0){w=startBox.w+lDx;}
    if(w<min){if(activeHandle.indexOf('w')>=0)x-=(min-w);w=min;}
    if(h<min){if(activeHandle.indexOf('n')>=0)y-=(min-h);h=min;}
    nodeToResize.setAttribute('x',x);nodeToResize.setAttribute('y',y);nodeToResize.setAttribute('width',w);nodeToResize.setAttribute('height',h);
    var label=g.querySelector('text[data-zone-label], text.text-label-text');if(label){label.setAttribute('x',0);label.setAttribute('y',4);}
    itemsLayer.querySelectorAll('.selection').forEach(function(n){n.remove();});showHandles(g);
  };
  var onUp=function(ev){try{handle.releasePointerCapture(ev.pointerId);}catch(_){}stage.removeEventListener('pointermove',onMove);stage.removeEventListener('pointerup',onUp);drawSelection();updateMetrics();};
  stage.addEventListener('pointermove',onMove);stage.addEventListener('pointerup',onUp);
}

// --- TEXT EDIT ---
function editTextLabel(e){
  var g=e.currentTarget;var textEl=g.querySelector('.text-label-text');var bgRect=g.querySelector('.text-label-bg');
  var bb=bgRect.getBBox();
  var fo=document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
  fo.setAttribute('x',bgRect.getAttribute('x'));fo.setAttribute('y',bgRect.getAttribute('y'));fo.setAttribute('width',bb.width);fo.setAttribute('height',bb.height);fo.classList.add('text-edit-foreign-object');
  var ta=document.createElement('textarea');ta.value=textEl.textContent;ta.classList.add('text-edit-textarea');fo.appendChild(ta);g.appendChild(fo);ta.focus();ta.select();textEl.style.display='none';
  var finish=function(){textEl.textContent=ta.value;g.removeChild(fo);textEl.style.display='block';updateMetrics();};
  ta.addEventListener('blur',finish);ta.addEventListener('keydown',function(ev){if(ev.key==='Enter'&&!ev.shiftKey){ev.preventDefault();finish();}});
}

// --- EXPORT ---
function exportPNG(){
  var clone=stage.cloneNode(true);clone.setAttribute('viewBox','0 0 1440 720');
  clone.querySelectorAll('.selection,.handle,#ghost *,#marquee').forEach(function(n){n.remove();});
  clone.querySelector('#roomB').setAttribute('opacity','1');
  var isDark=document.documentElement.classList.contains('dark');
  if(!toggleLegend.checked){var shell=clone.querySelector('#shell');shell.querySelectorAll('text,rect[id^="win"],rect[id^="door"]').forEach(function(n){n.setAttribute('opacity','0');});}
  var svgData=new XMLSerializer().serializeToString(clone);
  var img=new Image();var svgBlob=new Blob([svgData],{type:'image/svg+xml;charset=utf-8'});var url=URL.createObjectURL(svgBlob);
  img.onload=function(){var canvas=document.createElement('canvas');canvas.width=1440;canvas.height=720;var ctx=canvas.getContext('2d');ctx.fillStyle=isDark?'#111827':'#f6f7f9';ctx.fillRect(0,0,1440,720);ctx.drawImage(img,0,0);URL.revokeObjectURL(url);var png=canvas.toDataURL('image/png');var a=document.createElement('a');a.download='classroom-layout.png';a.href=png;a.click();};
  img.src=url;
}

// --- SPATIAL PLANNER LLM (uses shared API key) ---
async function generateLayoutFromLLM(){
  var userPrompt=llmPromptEl.value;if(!userPrompt){flash('Please describe your lesson first.');return;}
  var studentCountMatch=userPrompt.match(/\[(\d+)\]/);var studentCount=studentCountMatch?parseInt(studentCountMatch[1],10):32;
  llmGenerateBtn.disabled=true;llmGenerateBtn.textContent='Generating...';
  var key=apiKey||localStorage.getItem('cocher_api_key');
  if(!key){flash('Please set your API key in Settings.');llmGenerateBtn.disabled=false;llmGenerateBtn.textContent='Generate Layout';return;}
  var sysPrompt='You are an expert in spatial pedagogy. Analyze the lesson plan. Respond with JSON: {"preset":"direct|pods|stations|circle|quiet|maker|fishbowl|gallery","wall_A":"close|stack","wall_B":"close|stack","insights":[{"title":"string","affordance":"string","moves":["string"]}]} (exactly 3 insights). User: '+userPrompt;
  var payload={contents:[{role:'user',parts:[{text:sysPrompt}]}],generationConfig:{responseMimeType:'application/json'}};
  var model=geminiModel||'gemini-2.5-flash';
  var apiUrl='https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+key;
  try{
    var response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!response.ok) throw new Error('API Error: '+response.status);
    var result=await response.json();
    var rawJson=result.candidates[0].content.parts[0].text;var parsed=JSON.parse(rawJson);
    if(parsed.preset){applyPreset(parsed.preset,studentCount);document.getElementById('presetSelect').value=parsed.preset;}
    if(parsed.wall_A==='stack')stackWall('A');else closeWall('A');
    if(parsed.wall_B==='stack')stackWall('B');else closeWall('B');
    if(parsed.insights)renderInsights(parsed.insights);
    flash('Generated "'+parsed.preset+'" layout for '+studentCount+' students.');
  }catch(err){console.error('LLM Error:',err);flash('Error generating layout. Check console.');}
  llmGenerateBtn.disabled=false;llmGenerateBtn.textContent='Generate Layout';
}


// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 10: SPATIAL PLANNER EVENT WIRING                       ║
// ╚══════════════════════════════════════════════════════════════════╝

var marqueeActive=false, marqueeStart=null;
function handleStagePointerDown(e){
  var isOnItem=!!e.target.closest('g[data-id]');
  if(isOnItem){
    var targetG=e.target.closest('g[data-id]');var isWall=targetG.getAttribute('data-id')&&targetG.getAttribute('data-id').indexOf('ow-panel')===0;
    if(e.shiftKey){
      var hasFurniture=false;selected.forEach(function(n){if(!(n.getAttribute('data-id')&&n.getAttribute('data-id').indexOf('ow-panel')===0))hasFurniture=true;});
      if(isWall&&hasFurniture){flash('Wall panels cannot be grouped with furniture.');return;}
      if(selected.has(targetG))selected.delete(targetG);else selected.add(targetG);
    }else{if(!selected.has(targetG)){clearSelection();selected.add(targetG);}}
    if(selected.size===1&&targetG.getAttribute('data-resizable')==='1')showHandles(targetG);else removeHandles();
    drawSelection();
  }else{
    if(!e.shiftKey){clearSelection();removeHandles();}
    marqueeActive=true;marqueeStart=getMouseSVG(e);
    marquee.setAttribute('x',marqueeStart.x);marquee.setAttribute('y',marqueeStart.y);marquee.setAttribute('width',0);marquee.setAttribute('height',0);marquee.style.display='block';
  }
}
function handleStagePointerMove(e){
  if(!marqueeActive) return;var cur=getMouseSVG(e);
  var x=Math.min(cur.x,marqueeStart.x),y=Math.min(cur.y,marqueeStart.y);
  var w=Math.abs(cur.x-marqueeStart.x),h=Math.abs(cur.y-marqueeStart.y);
  marquee.setAttribute('x',x);marquee.setAttribute('y',y);marquee.setAttribute('width',w);marquee.setAttribute('height',h);
}
function handleStagePointerUp(e){
  if(!marqueeActive) return;marqueeActive=false;marquee.style.display='none';
  var mx=+marquee.getAttribute('x'),my=+marquee.getAttribute('y'),mw=+marquee.getAttribute('width'),mh=+marquee.getAttribute('height');
  var box={x:mx,y:my,w:mw,h:mh};
  var all=Array.from(layoutRoot.querySelectorAll('g[data-id]')).concat(Array.from(operableWallsLayer.querySelectorAll('g[data-id]')));
  var itemsInBox=all.filter(function(g){var t=getTranslate(g);return t[0]>=box.x&&t[0]<=box.x+box.w&&t[1]>=box.y&&t[1]<=box.y+box.h;});
  var hasWall=itemsInBox.some(function(g){return g.getAttribute('data-id')&&g.getAttribute('data-id').indexOf('ow-panel')===0;});
  var hasFurniture=itemsInBox.some(function(g){return!(g.getAttribute('data-id')&&g.getAttribute('data-id').indexOf('ow-panel')===0);});
  if(hasWall&&hasFurniture){flash('Wall panels cannot be grouped with furniture.');itemsInBox.forEach(function(g){if(!(g.getAttribute('data-id')&&g.getAttribute('data-id').indexOf('ow-panel')===0))selected.add(g);});}
  else{itemsInBox.forEach(function(g){selected.add(g);});}
  drawSelection();
}
function handleKeyDown(e){
  if(['TEXTAREA','INPUT'].indexOf(document.activeElement.tagName)>=0) return;
  if(e.key==='Alt') rotateSelection._lastAlt=true;
  if(e.key.toLowerCase()==='r'){
    if(selected.size===1){
      var node;selected.forEach(function(n){node=n;});
      if(node.getAttribute('data-id')&&node.getAttribute('data-id').indexOf('ow-panel')===0){
        var t=getTranslate(node);var cr=getRotate(node);var nr=(cr===0)?90:0;
        node.setAttribute('transform','translate('+t[0]+','+t[1]+') rotate('+nr+')');
        var r=node.querySelector('rect');var w=+r.getAttribute('width');var h=+r.getAttribute('height');
        r.setAttribute('width',h);r.setAttribute('height',w);r.setAttribute('x',-h/2);r.setAttribute('y',-w/2);
        drawSelection();updateMetrics();return;
      }
    }
    rotateSelection(e.shiftKey,e.altKey);
  }
  if((e.key==='Delete'||e.key==='Backspace')&&selected.size){selected.forEach(function(n){n.remove();});clearSelection();updateMetrics();}
  if(selected.size&&['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].indexOf(e.key)>=0){
    e.preventDefault();var step=e.altKey?5:(e.shiftKey?unit:15);
    selected.forEach(function(node){
      var t=getTranslate(node);var tx=t[0],ty=t[1];
      var isWall=node.getAttribute('data-id')&&node.getAttribute('data-id').indexOf('ow-panel')===0;
      if(e.key==='ArrowUp')ty-=step;if(e.key==='ArrowDown')ty+=step;
      if(e.key==='ArrowLeft'&&!isWall)tx-=step;if(e.key==='ArrowRight'&&!isWall)tx+=step;
      tx=Math.max(0,Math.min(tx,1440-unit));ty=Math.max(0,Math.min(ty,720-unit));
      node.setAttribute('transform','translate('+tx+','+ty+') rotate('+getRotate(node)+')');
    });
    drawSelection();updateMetrics();
  }
}

function populatePalette(){
  var mapCatToEl={furniture:document.getElementById('chips-furniture'),tech:document.getElementById('chips-tech'),cognitive:document.getElementById('chips-cognitive'),social:document.getElementById('chips-social'),emotional:document.getElementById('chips-emotional'),stations:document.getElementById('chips-stations'),zones:document.getElementById('chips-zones')};
  PALETTE.forEach(function(item){
    var chip=document.createElement('div');chip.className='chip';
    var sw=document.createElement('span');sw.className='swatch';
    if(item.id==='text_label'){sw.textContent='T';sw.style.fontWeight='bold';sw.style.textAlign='center';sw.style.lineHeight='14px';}
    else{sw.style.background=(item.id.indexOf('desk_')>=0?(item.id.indexOf('blue')>=0?'#bfdbfe':item.id.indexOf('green')>=0?'#bbf7d0':item.id.indexOf('orange')>=0?'#fed7aa':'#e5e7eb'):(item.cat==='cognitive'?'#93c5fd':item.cat==='social'?'#a7f3d0':item.cat==='emotional'?'#fde68a':'#e5e7eb'));}
    chip.appendChild(sw);chip.append(item.label);
    chip.addEventListener('click',function(){addItem(item);});
    mapCatToEl[item.cat].appendChild(chip);
  });
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 11: SPATIAL PLANNER INITIALIZATION                     ║
// ╚══════════════════════════════════════════════════════════════════╝

function initSpatialPlanner(){
  stage=document.getElementById('stage');
  itemsLayer=document.getElementById('items');
  layoutRoot=document.getElementById('layoutRoot');
  operableWallsLayer=document.getElementById('operableWalls');
  ghostLayer=document.getElementById('ghost');
  marquee=document.getElementById('marquee');
  toastEl=document.getElementById('toast');
  insightsContainer=document.getElementById('insightsContainer');
  wallAG=document.getElementById('wallA');
  wallBG=document.getElementById('wallB');
  toggleWall=document.getElementById('toggleWall');
  toggleSnap=document.getElementById('toggleSnap');
  toggleLegend=document.getElementById('toggleLegend');
  sceneName=document.getElementById('sceneName');
  sceneList=document.getElementById('sceneList');
  llmPromptEl=document.getElementById('llm-prompt');
  llmGenerateBtn=document.getElementById('llm-generate-btn');
  savePresetModal=document.getElementById('savePresetModal');
  customPresetNameInput=document.getElementById('customPresetNameInput');
  confirmSavePresetBtn=document.getElementById('confirmSavePreset');
  cancelSavePresetBtn=document.getElementById('cancelSavePreset');
  chartTooltip=document.getElementById('chartTooltip');
  rightPanel=document.getElementById('right-panel');

  populatePalette();
  buildOperableWalls();
  closeWall('A'); closeWall('B');

  // Event listeners for spatial planner
  stage.addEventListener('pointerdown',handleStagePointerDown);
  stage.addEventListener('pointermove',handleStagePointerMove);
  stage.addEventListener('pointerup',handleStagePointerUp);
  stage.addEventListener('pointerleave',clearGhost);
  window.addEventListener('keydown',handleKeyDown);
  window.addEventListener('keyup',function(e){if(e.key==='Alt')rotateSelection._lastAlt=false;});
  toggleWall.addEventListener('change',function(){var show=toggleWall.checked;operableWallsLayer.setAttribute('opacity',show?'1':'0');document.getElementById('trackA').setAttribute('opacity',show?'0.35':'0');document.getElementById('trackB').setAttribute('opacity',show?'0.35':'0');});
  toggleSnap.addEventListener('change',function(){flash(toggleSnap.checked?'Snap ON':'Snap OFF');});
  toggleLegend.addEventListener('change',function(){var show=toggleLegend.checked;var shell=document.getElementById('shell');shell.querySelectorAll('text,rect[id^="win"],rect[id^="door"]').forEach(function(n){n.setAttribute('opacity',show?'1':'0');});});
  document.getElementById('btnExport').addEventListener('click',exportPNG);
  document.getElementById('btnClear').addEventListener('click',function(){layoutRoot.innerHTML='';clearSelection();removeHandles();buildOperableWalls();closeWall('A');closeWall('B');updateMetrics();});
  document.getElementById('btnCloseA').onclick=function(){closeWall('A');};
  document.getElementById('btnCloseB').onclick=function(){closeWall('B');};
  document.getElementById('btnStackA').onclick=function(){stackWall('A',4);};
  document.getElementById('btnStackB').onclick=function(){stackWall('B',4);};
  document.getElementById('applyPreset').addEventListener('click',function(){var v=document.getElementById('presetSelect').value;if(!v)return;applyPreset(v,28);});
  document.getElementById('saveCustomPreset').addEventListener('click',showSavePresetModal);
  document.getElementById('saveScene').addEventListener('click',saveScene);
  llmGenerateBtn.addEventListener('click',generateLayoutFromLLM);
  confirmSavePresetBtn.addEventListener('click',handleConfirmSavePreset);
  cancelSavePresetBtn.addEventListener('click',hideSavePresetModal);
  savePresetModal.addEventListener('click',function(e){if(e.target===savePresetModal)hideSavePresetModal();});

  initializeChart();
  loadCustomPresets();
  spatialInitialized=true;
  updateMetrics();
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  SECTION 12: MAIN APP INITIALIZATION                            ║
// ╚══════════════════════════════════════════════════════════════════╝

function initApp(){
  // Dark mode
  var dm=document.getElementById('toggleDarkMode');
  var savedDark=localStorage.getItem('darkMode');
  if(savedDark==='true'||(!savedDark&&window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches)){
    dm.checked=true;document.documentElement.classList.add('dark');
  }
  dm.addEventListener('change',function(){
    document.documentElement.classList.toggle('dark',dm.checked);
    localStorage.setItem('darkMode',dm.checked);
    if(spatialInitialized){if(spatialChart)spatialChart.destroy();initializeChart();updateMetrics();}
  });

  // Mode tabs
  document.querySelectorAll('.mode-tab').forEach(function(tab){
    tab.addEventListener('click',function(){switchMode(tab.getAttribute('data-mode'));});
  });

  // Settings
  document.getElementById('settingsBtn').addEventListener('click',openSettings);
  document.getElementById('settingsTestKey').addEventListener('click', async function(){
    var btn=document.getElementById('settingsTestKey');
    var key=document.getElementById('settingsApiKey').value.trim();
    var model=document.getElementById('settingsModel').value;
    var statusEl=document.getElementById('settingsKeyStatus');
    if(!key){statusEl.style.display='block';statusEl.style.background='#fef2f2';statusEl.style.color='#991b1b';statusEl.style.border='1px solid #fecaca';statusEl.textContent='Please enter a key first.';return;}
    btn.textContent='Testing...';btn.disabled=true;
    try{
      await testApiKey(key,model);
      statusEl.style.display='block';statusEl.style.background='#f0fdf4';statusEl.style.color='#166534';statusEl.style.border='1px solid #bbf7d0';
      statusEl.textContent='Key works with '+model+'!';
    }catch(err){
      statusEl.style.display='block';statusEl.style.background='#fef2f2';statusEl.style.color='#991b1b';statusEl.style.border='1px solid #fecaca';
      statusEl.textContent=err.message;
    }
    btn.textContent='Test Key';btn.disabled=false;
  });
  document.getElementById('settingsSave').addEventListener('click',function(){
    apiKey=document.getElementById('settingsApiKey').value.trim();
    geminiModel=document.getElementById('settingsModel').value;
    localStorage.setItem('cocher_api_key',apiKey);
    localStorage.setItem('cocher_model',geminiModel);
    closeSettings();
  });
  document.getElementById('settingsCancel').addEventListener('click',closeSettings);
  document.getElementById('settingsModal').addEventListener('click',function(e){if(e.target===document.getElementById('settingsModal'))closeSettings();});

  // Chat
  document.getElementById('chatSend').addEventListener('click',function(){
    sendUserMessage(document.getElementById('chatInput').value);
  });
  document.getElementById('chatInput').addEventListener('keydown',function(e){
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendUserMessage(document.getElementById('chatInput').value);}
  });

  // Framework sidebar
  renderFrameworkSidebar();

  // Welcome message
  sendWelcomeMessage();
}

// ╔══════════════════════════════════════════════════════════════════╗
// ║  BOOT                                                           ║
// ╚══════════════════════════════════════════════════════════════════╝
initWelcome();

})();
</script>
</body>
</html>
